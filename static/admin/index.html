<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin â€“ Andreas Weiss</title>
<link rel="icon" type="image/svg+xml" href="/andreasweiss/assets/img/favicon.svg">
<link rel="icon" type="image/png" sizes="192x192" href="/andreasweiss/assets/img/icon-192.png">
<link rel="apple-touch-icon" href="/andreasweiss/assets/img/apple-touch-icon.png">
<meta name="theme-color" content="#1E6FB9">
<style>
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;background:#f0f2f5;color:#1d1d1f;min-height:100vh}

/* Login */
#login-view{display:flex;align-items:center;justify-content:center;min-height:100vh}
.login-card{background:#fff;padding:2.5rem;border-radius:16px;box-shadow:0 4px 24px rgba(0,0,0,.08);width:100%;max-width:380px}
.login-card h1{font-size:1.6rem;margin-bottom:.15rem;font-weight:700}
.login-card p.sub{color:#6e6e73;font-size:.85rem;margin-bottom:1.5rem}
.login-card input{display:block;width:100%;padding:.85rem 1rem;border:1.5px solid #e0e0e0;border-radius:10px;font-size:1rem;margin-bottom:.75rem;transition:border-color .2s,box-shadow .2s}
.login-card input:focus{outline:none;border-color:#1e6fb9;box-shadow:0 0 0 3px rgba(30,111,185,.12)}
.login-card button{display:block;width:100%;padding:.85rem;background:linear-gradient(135deg,#1e6fb9,#1a5fa0);color:#fff;border:none;border-radius:10px;font-size:1rem;cursor:pointer;font-weight:600;transition:transform .1s,box-shadow .1s}
.login-card button:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(30,111,185,.25)}
.login-card button:active{transform:translateY(0)}
.error{color:#dc2626;font-size:.85rem;margin-top:.5rem;text-align:center}

/* Dashboard */
#dashboard-view{max-width:1060px;margin:0 auto;padding:1.5rem 1rem 3rem}
[hidden]{display:none!important}

/* Header */
.dash-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:1.5rem;flex-wrap:wrap;gap:1rem}
.dash-header h1{font-size:1.6rem;font-weight:700}
.dash-header .sub{color:#6e6e73;font-size:.85rem;margin-top:.15rem}
.controls{display:flex;align-items:center;gap:.75rem;flex-wrap:wrap}
.controls select{padding:.5rem .85rem;border:1.5px solid #e0e0e0;border-radius:10px;font-size:.9rem;background:#fff;cursor:pointer;transition:border-color .2s}
.controls select:focus{outline:none;border-color:#1e6fb9}
.btn-link{color:#1e6fb9;text-decoration:none;font-size:.9rem;font-weight:500;transition:color .15s}
.btn-link:hover{text-decoration:underline;color:#1a5fa0}

/* Stats */
.stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(155px,1fr));gap:.75rem;margin-bottom:1.5rem}
.stat-card{background:#fff;padding:1.25rem;border-radius:14px;box-shadow:0 1px 4px rgba(0,0,0,.05);text-align:center;border-top:3px solid var(--sc,#1e6fb9);transition:transform .15s}
.stat-card:hover{transform:translateY(-2px)}
.stat-card:nth-child(1){--sc:#1E6FB9}
.stat-card:nth-child(2){--sc:#6A3FB5}
.stat-card:nth-child(3){--sc:#D97706}
.stat-card:nth-child(4){--sc:#16a34a}
.stat-card:nth-child(5){--sc:#B91C1C}
.stat-value{display:block;font-size:2.2rem;font-weight:800;color:var(--sc,#1e6fb9);line-height:1.2}
.stat-label{display:block;font-size:.78rem;color:#6e6e73;margin-top:.35rem;text-transform:uppercase;letter-spacing:.04em;font-weight:500}

/* Panels */
.panel{background:#fff;border-radius:14px;padding:1.5rem;box-shadow:0 1px 4px rgba(0,0,0,.05);margin-bottom:1rem}
.panel-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem}
.panel-header h2{font-size:1.15rem;font-weight:700}
.badge{background:#f0f2f5;padding:.2rem .65rem;border-radius:6px;font-size:.75rem;color:#6e6e73;font-weight:600}
.two-col{display:grid;grid-template-columns:1fr 1fr;gap:1rem}
@media(max-width:700px){.two-col{grid-template-columns:1fr}}

/* Tables */
table{width:100%;border-collapse:collapse}
th,td{padding:.6rem .75rem;text-align:left;border-bottom:1px solid #f0f0f2;font-size:.88rem}
th{font-weight:600;color:#8e8e93;font-size:.75rem;text-transform:uppercase;letter-spacing:.04em}
td{color:#3a3a3c}
tbody tr:hover{background:#fafbfc}

/* Bars â€“ stacked layout in topic cards */
.bar-row{margin-bottom:.75rem}
.bar-top{display:flex;justify-content:space-between;align-items:baseline;margin-bottom:.3rem}
.bar-label{font-size:.84rem;color:#3a3a3c;line-height:1.3}
.bar-value{font-size:.8rem;color:#6e6e73;white-space:nowrap;font-weight:500;flex-shrink:0;margin-left:.5rem}
.bar-track{width:100%;height:22px;background:#f0f2f5;border-radius:6px;overflow:hidden}
.bar-fill{height:100%;border-radius:6px;transition:width .5s ease;min-width:2px;background:var(--bar-color,#1e6fb9)}
.bar-fill.correct{background:#16a34a!important}
.bar-row.correct .bar-label{color:#16a34a;font-weight:700}
.bar-row.winner .bar-fill{box-shadow:0 0 0 2px rgba(30,111,185,.25)}

/* Tabs */
.tabs{display:flex;gap:.4rem;margin-bottom:.75rem}
.tab{padding:.4rem .85rem;border:1.5px solid #e0e0e0;border-radius:8px;background:#fff;font-size:.8rem;cursor:pointer;font-weight:500;transition:all .15s}
.tab:hover{background:#f5f5f7}
.tab.active{background:#1e6fb9;color:#fff;border-color:#1e6fb9}

/* Topic cards */
.topic-card{background:#fafbfc;border-radius:12px;padding:1.25rem;margin-bottom:1rem;border-left:4px solid var(--tc,#1e6fb9);transition:box-shadow .15s}
.topic-card:hover{box-shadow:0 2px 8px rgba(0,0,0,.06)}
.topic-card:last-child{margin-bottom:0}
.topic-card h3{font-size:1rem;font-weight:700;margin-bottom:.15rem;color:var(--tc,#1e6fb9)}
.topic-question{font-size:.88rem;color:#6e6e73;margin-bottom:.75rem;line-height:1.4}
.topic-stats{display:flex;gap:1.25rem;margin-bottom:.85rem;flex-wrap:wrap}
.topic-stat{font-size:.78rem;color:#8e8e93}
.topic-stat strong{font-size:1.1rem;color:#1d1d1f;display:block;font-weight:700}
.topic-kinder{--tc:#1E6FB9;--bar-color:#1E6FB9}
.topic-jugend{--tc:#6A3FB5;--bar-color:#6A3FB5}
.topic-familie{--tc:#D97706;--bar-color:#D97706}
.topic-innovation{--tc:#B91C1C;--bar-color:#B91C1C}

/* Feedback cards */
.fb-card{background:#fafbfc;border-radius:10px;padding:1rem 1.25rem;margin-bottom:.6rem;border-left:3px solid #D97706;transition:box-shadow .15s}
.fb-card:hover{box-shadow:0 2px 8px rgba(0,0,0,.06)}
.fb-card:last-child{margin-bottom:0}
.fb-meta{display:flex;gap:.75rem;font-size:.75rem;color:#8e8e93;margin-bottom:.4rem;flex-wrap:wrap;align-items:center}
.fb-page-tag{display:inline-block;background:#e8f0fe;color:#1e6fb9;padding:.15rem .55rem;border-radius:4px;font-size:.72rem;font-weight:600;text-transform:capitalize}
.fb-text{font-size:.9rem;line-height:1.5;color:#3a3a3c}

/* Exports */
.exports-row{display:flex;flex-wrap:wrap;gap:.5rem;align-items:center}
.export-btn{padding:.55rem 1.1rem;background:#fff;border:1.5px solid #e0e0e0;border-radius:10px;cursor:pointer;font-size:.82rem;font-weight:500;transition:all .15s;display:inline-flex;align-items:center;gap:.4rem}
.export-btn:hover{background:#f5f5f7;border-color:#c0c0c0;transform:translateY(-1px)}
.export-btn.primary{background:linear-gradient(135deg,#1e6fb9,#1a5fa0);color:#fff;border-color:transparent}
.export-btn.primary:hover{opacity:.92;transform:translateY(-1px)}
.export-icon{font-size:1rem}

.empty{color:#8e8e93;font-size:.88rem;font-style:italic;padding:.5rem 0}

/* Page dot */
.page-dot{display:inline-block;width:8px;height:8px;border-radius:50%;margin-right:.5rem;vertical-align:middle}

/* Uploads */
.upload-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(280px,1fr));gap:1rem}
.upload-card{background:#fafbfc;border-radius:12px;padding:1.25rem;border:1.5px dashed #d0d0d0;text-align:center;transition:border-color .2s,background .2s}
.upload-card:hover{border-color:#1e6fb9;background:#f5f8fc}
.upload-card.dragover{border-color:#1e6fb9;background:#e8f0fe}
.upload-card h3{font-size:.95rem;margin-bottom:.25rem}
.upload-card p{font-size:.78rem;color:#8e8e93;margin-bottom:.75rem}
.upload-card .preview{width:80px;height:80px;border-radius:10px;object-fit:cover;margin:0 auto .75rem;display:block;background:#f0f2f5}
.upload-card .preview-ph{width:80px;height:80px;border-radius:10px;margin:0 auto .75rem;display:flex;align-items:center;justify-content:center;background:#f0f2f5;font-size:2rem;color:#c0c0c0}
.upload-input{display:none}
.upload-label{display:inline-block;padding:.55rem 1.2rem;background:linear-gradient(135deg,#1e6fb9,#1a5fa0);color:#fff;border-radius:10px;cursor:pointer;font-size:.82rem;font-weight:600;transition:transform .1s,opacity .15s}
.upload-label:hover{transform:translateY(-1px);opacity:.92}
.upload-status{font-size:.78rem;margin-top:.5rem;min-height:1.2em;color:#6e6e73}
.upload-status.ok{color:#16a34a}
.upload-status.err{color:#dc2626}
</style>
</head>
<body>

<!-- â”€â”€ Login â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="login-view">
  <div class="login-card">
    <h1>Admin</h1>
    <p class="sub">Andreas Weiss Â· Kommunalwahl Rohrbach</p>
    <input type="text" id="user" placeholder="Benutzer" autocomplete="username" autofocus>
    <input type="password" id="pass" placeholder="Passwort" autocomplete="current-password">
    <button id="login-btn">Anmelden</button>
    <p id="login-error" class="error" hidden>UngÃ¼ltige Zugangsdaten</p>
  </div>
</div>

<!-- â”€â”€ Dashboard â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ -->
<div id="dashboard-view" hidden>
  <div class="dash-header">
    <div>
      <h1>ğŸ“Š Dashboard</h1>
      <p class="sub">Andreas Weiss Â· Kommunalwahl Rohrbach Â· <span style="color:#aaa">v1.0.0</span></p>
    </div>
    <div class="controls">
      <select id="period">
        <option value="7">7 Tage</option>
        <option value="30" selected>30 Tage</option>
        <option value="90">90 Tage</option>
        <option value="365">1 Jahr</option>
      </select>
      <a href="/andreasweiss/" class="btn-link">â† Zur Website</a>
      <a href="#" class="btn-link" id="logout-btn" style="color:#dc2626">Abmelden</a>
    </div>
  </div>

  <!-- Stats -->
  <div class="stats-grid">
    <div class="stat-card"><span class="stat-value" id="sv-visits">â€“</span><span class="stat-label">Besuche gesamt</span></div>
    <div class="stat-card"><span class="stat-value" id="sv-unique">â€“</span><span class="stat-label">Unique heute</span></div>
    <div class="stat-card"><span class="stat-value" id="sv-polls">â€“</span><span class="stat-label">Umfrage-Stimmen</span></div>
    <div class="stat-card"><span class="stat-value" id="sv-quiz">â€“</span><span class="stat-label">Quiz-Antworten</span></div>
    <div class="stat-card"><span class="stat-value" id="sv-feedback">â€“</span><span class="stat-label">RÃ¼ckmeldungen</span></div>
  </div>

  <!-- Daily Chart -->
  <section class="panel">
    <div class="panel-header">
      <h2>ğŸ“ˆ Besuche pro Tag</h2>
      <span class="badge" id="daily-avg"></span>
    </div>
    <div id="daily-chart"></div>
  </section>

  <!-- Pages & Geo -->
  <div class="two-col">
    <section class="panel">
      <div class="panel-header"><h2>ğŸ“„ Seiten</h2></div>
      <table id="tbl-pages"><thead><tr><th>Seite</th><th style="text-align:right">Aufrufe</th></tr></thead><tbody></tbody></table>
    </section>
    <section class="panel">
      <div class="panel-header"><h2>ğŸ“ Herkunft</h2></div>
      <div class="tabs" id="geo-tabs">
        <button class="tab active" data-t="cities">StÃ¤dte</button>
        <button class="tab" data-t="regions">Regionen</button>
        <button class="tab" data-t="countries">LÃ¤nder</button>
      </div>
      <table id="tbl-geo"><thead><tr><th>Ort</th><th style="text-align:right">Aufrufe</th></tr></thead><tbody></tbody></table>
    </section>
  </div>

  <!-- Polls -->
  <section class="panel">
    <div class="panel-header">
      <h2>ğŸ—³ï¸ Umfrage-Ergebnisse</h2>
      <span class="badge" id="polls-badge"></span>
    </div>
    <div id="polls-content"></div>
  </section>

  <!-- Quiz -->
  <section class="panel">
    <div class="panel-header">
      <h2>â“ Quiz-Ergebnisse</h2>
      <span class="badge" id="quiz-badge"></span>
    </div>
    <div id="quiz-content"></div>
  </section>

  <!-- Feedback -->
  <section class="panel">
    <div class="panel-header">
      <h2>ğŸ’¬ RÃ¼ckmeldungen</h2>
      <span class="badge" id="fb-badge"></span>
    </div>
    <div id="feedback-content"></div>
  </section>

  <!-- Exports -->
  <section class="panel">
    <div class="panel-header"><h2>ğŸ“¥ Daten exportieren</h2></div>
    <div class="exports-row">
      <button class="export-btn primary" onclick="doExportAll()"><span class="export-icon">ğŸ“¦</span> Alles exportieren</button>
      <button class="export-btn" onclick="doExport('visits')"><span class="export-icon">ğŸ‘</span> Besuche</button>
      <button class="export-btn" onclick="doExport('poll')"><span class="export-icon">ğŸ—³</span> Umfragen</button>
      <button class="export-btn" onclick="doExport('quiz')"><span class="export-icon">â“</span> Quiz</button>
      <button class="export-btn" onclick="doExport('feedback')"><span class="export-icon">ğŸ’¬</span> RÃ¼ckmeldungen</button>
    </div>
  </section>

  <!-- Uploads -->
  <section class="panel">
    <div class="panel-header"><h2>ğŸ“¤ Dateien hochladen</h2></div>
    <div class="upload-grid">
      <div class="upload-card" id="uc-portrait">
        <img src="/andreasweiss/assets/img/portrait.jpg" class="preview" id="prev-portrait" onerror="this.style.display='none';this.nextElementSibling.style.display='flex'">
        <div class="preview-ph" style="display:none">ğŸ‘¤</div>
        <h3>Portrait</h3>
        <p>JPG, PNG oder WebP Â· max. 5 MB</p>
        <input type="file" accept="image/jpeg,image/png,image/webp" class="upload-input" id="file-portrait">
        <label for="file-portrait" class="upload-label">ğŸ“· Bild wÃ¤hlen</label>
        <div class="upload-status" id="status-portrait"></div>
      </div>
      <div class="upload-card" id="uc-logo">
        <img src="/andreasweiss/assets/img/spd-logo.svg" class="preview" id="prev-logo" style="object-fit:contain" onerror="this.src='/andreasweiss/assets/img/spd-logo.png';this.onerror=function(){this.style.display='none';this.nextElementSibling.style.display='flex'}">
        <div class="preview-ph" style="display:none">ğŸ·ï¸</div>
        <h3>Partei-Logo</h3>
        <p>SVG, PNG, JPG oder WebP Â· max. 5 MB</p>
        <input type="file" accept="image/svg+xml,image/png,image/jpeg,image/webp" class="upload-input" id="file-logo">
        <label for="file-logo" class="upload-label">ğŸ·ï¸ Logo wÃ¤hlen</label>
        <div class="upload-status" id="status-logo"></div>
      </div>
      <div class="upload-card" id="uc-geoip">
        <div class="preview-ph">ğŸŒ</div>
        <h3>GeoIP Datenbank</h3>
        <p>GeoLite2-City.mmdb Â· max. 150 MB</p>
        <input type="file" accept=".mmdb" class="upload-input" id="file-geoip">
        <label for="file-geoip" class="upload-label">ğŸŒ Datei wÃ¤hlen</label>
        <div class="upload-status" id="status-geoip"></div>
      </div>
    </div>
  </section>
</div>

<script>
(function(){
"use strict";
var API="/andreasweiss/api";
var auth="";
var geoData={};

var THEME_COLORS={kinder:"#1E6FB9",jugend:"#6A3FB5",familie:"#D97706",innovation:"#B91C1C"};

// â”€â”€ Login â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var loginBtn=document.getElementById("login-btn");
var passInput=document.getElementById("pass");
var userInput=document.getElementById("user");

loginBtn.addEventListener("click",doLogin);
passInput.addEventListener("keydown",function(e){if(e.key==="Enter")doLogin()});
userInput.addEventListener("keydown",function(e){if(e.key==="Enter")passInput.focus()});

// Auto-login from saved session
var saved=localStorage.getItem("aw_admin_auth");
if(saved){
  auth=saved;
  apiFetch("/admin/stats?period=30").then(function(d){
    document.getElementById("login-view").hidden=true;
    document.getElementById("dashboard-view").hidden=false;
    render(d);
  }).catch(function(){
    localStorage.removeItem("aw_admin_auth");
    auth="";
  });
}

// Logout
document.getElementById("logout-btn").addEventListener("click",function(e){
  e.preventDefault();
  localStorage.removeItem("aw_admin_auth");
  auth="";
  document.getElementById("dashboard-view").hidden=true;
  document.getElementById("login-view").hidden=false;
  document.getElementById("user").value="";
  document.getElementById("pass").value="";
  document.getElementById("login-error").hidden=true;
  document.getElementById("login-btn").textContent="Anmelden";
  document.getElementById("login-btn").disabled=false;
});

function doLogin(){
  var u=userInput.value;
  var p=passInput.value;
  auth="Basic "+btoa(u+":"+p);
  loginBtn.textContent="Ladenâ€¦";
  loginBtn.disabled=true;
  apiFetch("/admin/stats?period=30").then(function(d){
    localStorage.setItem("aw_admin_auth",auth);
    document.getElementById("login-view").hidden=true;
    document.getElementById("dashboard-view").hidden=false;
    render(d);
  }).catch(function(){
    document.getElementById("login-error").hidden=false;
    loginBtn.textContent="Anmelden";
    loginBtn.disabled=false;
    auth="";
  });
}

function apiFetch(url){
  return fetch(API+url,{headers:{"Authorization":auth}}).then(function(r){
    if(!r.ok)throw new Error(r.status);
    return r.json();
  });
}

// â”€â”€ Period change â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById("period").addEventListener("change",function(){
  if(!auth)return;
  apiFetch("/admin/stats?period="+this.value).then(render).catch(function(){});
});

// â”€â”€ Render â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function render(d){
  geoData={cities:d.top_cities,regions:d.top_regions,countries:d.top_countries};
  var tp=0,tq=0;
  for(var k in d.polls)tp+=d.polls[k].total;
  for(var k2 in d.quizzes)tq+=d.quizzes[k2].total;

  document.getElementById("sv-visits").textContent=num(d.total_visits);
  document.getElementById("sv-unique").textContent=num(d.unique_today);
  document.getElementById("sv-polls").textContent=num(tp);
  document.getElementById("sv-quiz").textContent=num(tq);
  document.getElementById("sv-feedback").textContent=num(d.feedback_count);

  document.getElementById("polls-badge").textContent=tp+" Stimmen";
  document.getElementById("quiz-badge").textContent=tq+" Antworten";
  document.getElementById("fb-badge").textContent=(d.feedback_count||0)+" gesamt";

  renderDaily(d.daily);
  renderPages(d.per_page);
  renderGeo("cities");
  renderPolls(d.polls,d.content_meta);
  renderQuizzes(d.quizzes,d.content_meta);
  renderFeedback(d.feedback,d.feedback_count);
}

function num(n){return(n||0).toLocaleString("de-DE")}

// â”€â”€ Daily â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderDaily(daily){
  var c=document.getElementById("daily-chart");
  var avgEl=document.getElementById("daily-avg");
  if(!daily||!daily.length){c.innerHTML='<p class="empty">Keine Daten im Zeitraum</p>';avgEl.textContent="";return}
  var max=Math.max.apply(null,daily.map(function(d){return d.total}));
  var sum=daily.reduce(function(s,d){return s+d.total},0);
  avgEl.textContent="Ã˜ "+Math.round(sum/daily.length)+"/Tag";
  c.innerHTML=daily.map(function(d){
    var pct=max?Math.round(d.total/max*100):0;
    var dayStr=d.day.length>5?d.day.substring(5):d.day;
    return '<div class="bar-row"><div class="bar-top"><span class="bar-label">'+esc(dayStr)+
      '</span><span class="bar-value">'+d.total+
      ' <span style="color:#aaa">('+d.uniq+' unique)</span></span></div>'+
      '<div class="bar-track"><div class="bar-fill" style="width:'+pct+
      '%;--bar-color:#1e6fb9"></div></div></div>';
  }).join("");
}

// â”€â”€ Pages â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderPages(pages){
  var tb=document.querySelector("#tbl-pages tbody");
  if(!pages||!pages.length){tb.innerHTML='<tr><td colspan="2" class="empty">Keine Daten</td></tr>';return}
  var max=pages[0].cnt||1;
  tb.innerHTML=pages.map(function(p){
    var color=THEME_COLORS[p.page]||"#1e6fb9";
    var pct=Math.round(p.cnt/max*100);
    return '<tr><td><span class="page-dot" style="background:'+color+'"></span>'+esc(p.page)+
      '</td><td style="text-align:right"><div style="display:flex;align-items:center;justify-content:flex-end;gap:.5rem">'+
      '<div style="width:60px;height:6px;background:#f0f2f5;border-radius:3px;overflow:hidden">'+
      '<div style="height:100%;width:'+pct+'%;background:'+color+';border-radius:3px"></div></div>'+
      p.cnt+'</div></td></tr>';
  }).join("");
}

// â”€â”€ Geo tabs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById("geo-tabs").addEventListener("click",function(e){
  var t=e.target.closest(".tab");
  if(!t)return;
  document.querySelectorAll("#geo-tabs .tab").forEach(function(b){b.classList.remove("active")});
  t.classList.add("active");
  renderGeo(t.dataset.t);
});

function renderGeo(tab){
  var rows=geoData[tab]||[];
  var tb=document.querySelector("#tbl-geo tbody");
  var keyName=tab==="cities"?"city":tab==="regions"?"region":"country";
  if(!rows.length){tb.innerHTML='<tr><td colspan="2" class="empty">Keine Daten</td></tr>';return}
  tb.innerHTML=rows.map(function(r){
    return '<tr><td>'+esc(r[keyName])+'</td><td style="text-align:right">'+r.cnt+'</td></tr>';
  }).join("");
}

// â”€â”€ Polls â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderPolls(polls,meta){
  var el=document.getElementById("polls-content");
  var ids=Object.keys(polls);
  if(!ids.length){el.innerHTML='<p class="empty">Noch keine Stimmen abgegeben</p>';return}
  var html="";
  ids.forEach(function(id){
    var d=polls[id];
    var m=meta[id]||{};
    var theme=m.theme||"";
    var slug=m.page||"";
    var question=m.question||id;
    var topOpt="",topCnt=0;
    var sorted=Object.entries(d.options).sort(function(a,b){return b[1]-a[1]});
    if(sorted.length){topOpt=sorted[0][0];topCnt=sorted[0][1]}

    html+='<div class="topic-card topic-'+esc(slug)+'">';
    html+='<h3>'+esc(theme)+'</h3>';
    html+='<div class="topic-question">'+esc(question)+'</div>';
    html+='<div class="topic-stats"><div class="topic-stat"><strong>'+d.total+'</strong>Stimmen gesamt</div><div class="topic-stat"><strong>'+esc(topOpt)+'</strong>Beliebteste ('+topCnt+')</div></div>';
    sorted.forEach(function(item,i){
      var pct=d.total?Math.round(item[1]/d.total*100):0;
      var cls=i===0?" winner":"";
      html+='<div class="bar-row'+cls+'"><div class="bar-top"><span class="bar-label">'+esc(item[0])+
        '</span><span class="bar-value">'+pct+'% <span style="color:#aaa">('+item[1]+')</span></span></div>'+
        '<div class="bar-track"><div class="bar-fill" style="width:'+pct+
        '%"></div></div></div>';
    });
    html+='</div>';
  });
  el.innerHTML=html;
}

// â”€â”€ Quizzes â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderQuizzes(quizzes,meta){
  var el=document.getElementById("quiz-content");
  var ids=Object.keys(quizzes);
  if(!ids.length){el.innerHTML='<p class="empty">Noch keine Quiz-Antworten</p>';return}
  var html="";
  ids.forEach(function(id){
    var d=quizzes[id];
    var m=meta[id]||{};
    var theme=m.theme||"";
    var slug=m.page||"";
    var question=m.question||id;
    var rate=d.total?Math.round(d.correct/d.total*100):0;
    var rateColor=rate>=50?"#16a34a":"#dc2626";

    html+='<div class="topic-card topic-'+esc(slug)+'">';
    html+='<h3>'+esc(theme)+'</h3>';
    html+='<div class="topic-question">'+esc(question)+'</div>';
    html+='<div class="topic-stats"><div class="topic-stat"><strong>'+d.total+'</strong>Antworten</div><div class="topic-stat"><strong style="color:'+rateColor+'">'+rate+'%</strong>Richtig beantwortet</div><div class="topic-stat"><strong>'+d.correct+'</strong>Davon korrekt</div></div>';
    var sorted=Object.entries(d.options).sort(function(a,b){return b[1].count-a[1].count});
    sorted.forEach(function(item){
      var info=item[1];
      var pct=d.total?Math.round(info.count/d.total*100):0;
      var cls=info.is_correct?" correct":"";
      html+='<div class="bar-row'+cls+'"><div class="bar-top"><span class="bar-label">'+(info.is_correct?"âœ… ":"âŒ ")+esc(item[0])+
        '</span><span class="bar-value">'+pct+'% <span style="color:#aaa">('+info.count+')</span></span></div>'+
        '<div class="bar-track"><div class="bar-fill'+cls+'" style="width:'+pct+
        '%"></div></div></div>';
    });
    html+='</div>';
  });
  el.innerHTML=html;
}

// â”€â”€ Feedback â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderFeedback(items,total){
  var el=document.getElementById("feedback-content");
  if(!items||!items.length){el.innerHTML='<p class="empty">Noch keine RÃ¼ckmeldungen eingegangen</p>';return}
  var html="";
  items.forEach(function(f){
    var dateStr=f.ts?f.ts.replace("T"," ").substring(0,16):"";
    html+='<div class="fb-card">';
    html+='<div class="fb-meta"><span class="fb-page-tag">'+esc(f.page)+'</span><span>ğŸ“… '+esc(dateStr)+'</span>';
    if(f.city&&f.city!=="unknown")html+='<span>ğŸ“ '+esc(f.city)+'</span>';
    html+='</div>';
    html+='<div class="fb-text">'+esc(f.message)+'</div>';
    html+='</div>';
  });
  el.innerHTML=html;
}

// â”€â”€ Export â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.doExport=function(type){
  var period=document.getElementById("period").value;
  fetch(API+"/admin/export.csv?type="+type+"&period="+period,{
    headers:{"Authorization":auth}
  }).then(function(r){
    if(!r.ok)throw new Error();
    return r.blob();
  }).then(function(blob){
    var url=URL.createObjectURL(blob);
    var a=document.createElement("a");
    a.href=url;a.download=type+"_export_"+period+"d.csv";a.click();
    URL.revokeObjectURL(url);
  }).catch(function(){alert("Export fehlgeschlagen")});
};

window.doExportAll=function(){
  var types=["visits","poll","quiz","feedback"];
  types.forEach(function(t,i){
    setTimeout(function(){window.doExport(t)},i*400);
  });
};

function esc(s){
  var d=document.createElement("div");
  d.textContent=String(s);
  return d.innerHTML;
}

// â”€â”€ Uploads â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function setupUpload(inputId, endpoint, statusId, previewId){
  var input=document.getElementById(inputId);
  var statusEl=document.getElementById(statusId);
  var card=input.closest(".upload-card");

  input.addEventListener("change",function(){
    if(!input.files.length)return;
    doUpload(input.files[0],endpoint,statusEl,previewId);
  });

  // Drag & drop
  card.addEventListener("dragover",function(e){e.preventDefault();card.classList.add("dragover")});
  card.addEventListener("dragleave",function(){card.classList.remove("dragover")});
  card.addEventListener("drop",function(e){
    e.preventDefault();
    card.classList.remove("dragover");
    if(e.dataTransfer.files.length){
      doUpload(e.dataTransfer.files[0],endpoint,statusEl,previewId);
    }
  });
}

function doUpload(file,endpoint,statusEl,previewId){
  statusEl.className="upload-status";
  statusEl.textContent="Hochladenâ€¦ ("+formatBytes(file.size)+")";
  var fd=new FormData();
  fd.append("file",file);
  fetch(API+endpoint,{
    method:"POST",
    headers:{"Authorization":auth},
    body:fd
  }).then(function(r){
    if(!r.ok)return r.json().then(function(d){throw new Error(d.detail||"Fehler")});
    return r.json();
  }).then(function(d){
    statusEl.className="upload-status ok";
    statusEl.textContent="âœ… "+d.file+" hochgeladen ("+formatBytes(d.size)+")";
    if(previewId){
      var prev=document.getElementById(previewId);
      if(prev){
        prev.src=prev.src.split("?")[0]+"?t="+Date.now();
        prev.style.display="block";
        var ph=prev.nextElementSibling;
        if(ph&&ph.classList.contains("preview-ph"))ph.style.display="none";
      }
    }
  }).catch(function(err){
    statusEl.className="upload-status err";
    statusEl.textContent="âŒ "+err.message;
  });
}

function formatBytes(b){
  if(b<1024)return b+" B";
  if(b<1048576)return(b/1024).toFixed(1)+" KB";
  return(b/1048576).toFixed(1)+" MB";
}

setupUpload("file-portrait","/admin/upload/portrait","status-portrait","prev-portrait");
setupUpload("file-logo","/admin/upload/logo","status-logo","prev-logo");
setupUpload("file-geoip","/admin/upload/geoip","status-geoip",null);
})();
</script>
</body>
</html>
