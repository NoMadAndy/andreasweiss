<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Plattform-Admin Â· Wahl2026</title>
<link rel="icon" type="image/svg+xml" href="/assets/img/favicon.svg">
<meta name="theme-color" content="#7c3aed">
<style>
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;background:#f0f2f5;color:#1d1d1f;min-height:100vh}
#login-view{display:flex;align-items:center;justify-content:center;min-height:100vh}
.login-card{background:#fff;padding:2.5rem;border-radius:16px;box-shadow:0 4px 24px rgba(0,0,0,.08);width:100%;max-width:380px}
.login-card h1{font-size:1.6rem;margin-bottom:.15rem;font-weight:700}
.login-card p.sub{color:#6e6e73;font-size:.85rem;margin-bottom:1.5rem}
.login-card input{display:block;width:100%;padding:.85rem 1rem;border:1.5px solid #e0e0e0;border-radius:10px;font-size:1rem;margin-bottom:.75rem;transition:border-color .2s}
.login-card input:focus{outline:none;border-color:#7c3aed;box-shadow:0 0 0 3px rgba(124,58,237,.12)}
.login-card button{display:block;width:100%;padding:.85rem;background:linear-gradient(135deg,#7c3aed,#6d28d9);color:#fff;border:none;border-radius:10px;font-size:1rem;cursor:pointer;font-weight:600}
.login-card button:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(124,58,237,.25)}
.error{color:#dc2626;font-size:.85rem;margin-top:.5rem;text-align:center}
#dashboard-view{max-width:1060px;margin:0 auto;padding:1.5rem 1rem 3rem}
[hidden]{display:none!important}
.dash-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:1.5rem;flex-wrap:wrap;gap:1rem}
.dash-header h1{font-size:1.6rem;font-weight:700}
.dash-header .sub{color:#6e6e73;font-size:.85rem;margin-top:.15rem}
.controls{display:flex;align-items:center;gap:.75rem;flex-wrap:wrap}
.btn-link{color:#7c3aed;text-decoration:none;font-size:.9rem;font-weight:500}
.btn-link:hover{text-decoration:underline}
/* Tabs */
.tab-bar{display:flex;gap:.25rem;border-bottom:2px solid #e0e0e0;margin-bottom:1.5rem;overflow-x:auto}
.tab-btn{padding:.65rem 1.1rem;background:none;border:none;border-bottom:2px solid transparent;margin-bottom:-2px;cursor:pointer;font-size:.88rem;font-weight:600;color:#6e6e73;white-space:nowrap;font-family:inherit;transition:color .15s,border-color .15s}
.tab-btn.active{color:#7c3aed;border-bottom-color:#7c3aed}
.tab-btn:hover{color:#1d1d1f}
.tab-panel{display:none}.tab-panel.active{display:block}
/* Stats */
.stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:.75rem;margin-bottom:1.5rem}
.stat-card{background:#fff;padding:1.25rem;border-radius:14px;box-shadow:0 1px 4px rgba(0,0,0,.05);text-align:center;border-top:3px solid var(--sc,#7c3aed)}
.stat-card:nth-child(1){--sc:#7c3aed}.stat-card:nth-child(2){--sc:#1E6FB9}.stat-card:nth-child(3){--sc:#D97706}.stat-card:nth-child(4){--sc:#16a34a}.stat-card:nth-child(5){--sc:#B91C1C}.stat-card:nth-child(6){--sc:#0891b2}
.stat-value{display:block;font-size:2.2rem;font-weight:800;color:var(--sc,#7c3aed);line-height:1.2}
.stat-label{display:block;font-size:.78rem;color:#6e6e73;margin-top:.35rem;text-transform:uppercase;letter-spacing:.04em;font-weight:500}
/* Panels */
.panel{background:#fff;border-radius:14px;padding:1.5rem;box-shadow:0 1px 4px rgba(0,0,0,.05);margin-bottom:1rem}
.panel-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;flex-wrap:wrap;gap:.5rem}
.panel-header h2{font-size:1.15rem;font-weight:700}
.badge{background:#f0f2f5;padding:.2rem .65rem;border-radius:6px;font-size:.75rem;color:#6e6e73;font-weight:600}
/* Table */
table{width:100%;border-collapse:collapse}
th,td{padding:.6rem .75rem;text-align:left;border-bottom:1px solid #f0f0f2;font-size:.88rem}
th{font-weight:600;color:#8e8e93;font-size:.75rem;text-transform:uppercase;letter-spacing:.04em}
tbody tr:hover{background:#fafbfc}
td .mini{font-size:.72rem;color:#8e8e93;display:block;margin-top:.1rem}
/* Charts */
.bar-row{margin-bottom:.75rem}
.bar-top{display:flex;justify-content:space-between;align-items:baseline;margin-bottom:.3rem}
.bar-label{font-size:.84rem;color:#3a3a3c;line-height:1.3}
.bar-value{font-size:.8rem;color:#6e6e73;white-space:nowrap;font-weight:500}
.bar-track{width:100%;height:22px;background:#f0f2f5;border-radius:6px;overflow:hidden}
.bar-fill{height:100%;border-radius:6px;transition:width .5s;min-width:2px;background:var(--bar-color,#7c3aed)}
/* Buttons & Forms */
.export-btn{padding:.55rem 1.1rem;background:#fff;border:1.5px solid #e0e0e0;border-radius:10px;cursor:pointer;font-size:.82rem;font-weight:500;transition:all .15s;display:inline-flex;align-items:center;gap:.4rem;font-family:inherit}
.export-btn:hover{background:#f5f5f7;border-color:#c0c0c0}
.export-btn.primary{background:linear-gradient(135deg,#7c3aed,#6d28d9);color:#fff;border-color:transparent}
.export-btn.primary:hover{opacity:.92}
.export-btn.green{background:linear-gradient(135deg,#16a34a,#15803d);color:#fff;border-color:transparent}
.export-btn.green:hover{opacity:.92}
.exports-row{display:flex;flex-wrap:wrap;gap:.5rem;align-items:center}
/* Upload */
.upload-card{background:#fafbfc;border-radius:12px;padding:1.25rem;border:1.5px dashed #d0d0d0;text-align:center;transition:border-color .2s;max-width:400px}
.upload-card:hover{border-color:#7c3aed;background:#f5f3ff}
.upload-card.dragover{border-color:#7c3aed;background:#ede9fe}
.upload-card h3{font-size:.95rem;margin-bottom:.25rem}
.upload-card p{font-size:.78rem;color:#8e8e93;margin-bottom:.75rem}
.upload-input{display:none}
.upload-label{display:inline-block;padding:.55rem 1.2rem;background:linear-gradient(135deg,#16a34a,#15803d);color:#fff;border-radius:10px;cursor:pointer;font-size:.82rem;font-weight:600}
.upload-label:hover{transform:translateY(-1px);opacity:.92}
.upload-status{font-size:.78rem;margin-top:.5rem;min-height:1.2em;color:#6e6e73}
.upload-status.ok{color:#16a34a}.upload-status.err{color:#dc2626}
.candidate-color{display:inline-block;width:12px;height:12px;border-radius:3px;margin-right:.4rem;vertical-align:middle}
.empty{color:#8e8e93;font-size:.88rem;font-style:italic;padding:.5rem 0}
/* Settings Form */
.settings-form .fg{margin-bottom:1rem}
.settings-form label{display:block;font-size:.82rem;font-weight:600;margin-bottom:.3rem;color:#3a3a3c}
.settings-form input,.settings-form textarea{display:block;width:100%;padding:.7rem .9rem;border:1.5px solid #e0e0e0;border-radius:8px;font-size:.92rem;font-family:inherit;transition:border-color .2s}
.settings-form input:focus,.settings-form textarea:focus{outline:none;border-color:#7c3aed;box-shadow:0 0 0 3px rgba(124,58,237,.1)}
.settings-form textarea{min-height:60px;resize:vertical}
.save-btn{padding:.65rem 1.5rem;background:linear-gradient(135deg,#7c3aed,#6d28d9);color:#fff;border:none;border-radius:10px;font-size:.92rem;cursor:pointer;font-weight:600;font-family:inherit}
.save-btn:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(124,58,237,.25)}
.save-btn:disabled{opacity:.6;cursor:default;transform:none}
.form-msg{font-size:.82rem;margin-top:.5rem;min-height:1.2em}
.form-msg.ok{color:#16a34a}.form-msg.err{color:#dc2626}
/* Register */
.register-form .fg{margin-bottom:.85rem}
.register-form label{display:block;font-size:.82rem;font-weight:600;margin-bottom:.3rem;color:#3a3a3c}
.register-form input{display:block;width:100%;padding:.7rem .9rem;border:1.5px solid #e0e0e0;border-radius:8px;font-size:.92rem;font-family:inherit;transition:border-color .2s}
.register-form input:focus{outline:none;border-color:#7c3aed;box-shadow:0 0 0 3px rgba(124,58,237,.1)}
.register-form .hint{font-size:.72rem;color:#8e8e93;margin-top:.2rem}
.two-col{display:grid;grid-template-columns:1fr 1fr;gap:1.5rem}
@media(max-width:700px){.stats-grid{grid-template-columns:repeat(2,1fr)}.two-col{grid-template-columns:1fr}}
</style>
</head>
<body>
<div id="login-view">
  <div class="login-card">
    <h1>ğŸ”§ Plattform-Admin</h1>
    <p class="sub">Wahl2026 Â· Gesamtverwaltung</p>
    <input type="text" id="user" placeholder="Benutzer" autocomplete="username" autofocus>
    <input type="password" id="pass" placeholder="Passwort" autocomplete="current-password">
    <button id="login-btn">Anmelden</button>
    <p id="login-error" class="error" hidden>UngÃ¼ltige Zugangsdaten</p>
  </div>
</div>

<div id="dashboard-view" hidden>
  <div class="dash-header">
    <div>
      <h1>ğŸ”§ Plattform-Admin</h1>
      <p class="sub">Wahl2026 Â· GesamtÃ¼bersicht</p>
    </div>
    <div class="controls">
      <a href="/" class="btn-link">ğŸ  Startseite</a>
      <a href="#" class="btn-link" id="logout-btn" style="color:#dc2626">Abmelden</a>
    </div>
  </div>

  <!-- Tab Bar -->
  <div class="tab-bar">
    <button class="tab-btn active" data-tab="stats">ğŸ“Š Statistiken</button>
    <button class="tab-btn" data-tab="candidates">ğŸ‘¥ Kandidaten</button>
    <button class="tab-btn" data-tab="settings">âš™ï¸ Startseite</button>
    <button class="tab-btn" data-tab="data">ğŸ—„ï¸ Daten</button>
  </div>

  <!-- â•â•â• Tab: Stats â•â•â• -->
  <div class="tab-panel active" id="tab-stats">
    <div class="stats-grid">
      <div class="stat-card"><span class="stat-value" id="sv-candidates">â€“</span><span class="stat-label">Kandidaten</span></div>
      <div class="stat-card"><span class="stat-value" id="sv-visits">â€“</span><span class="stat-label">Besuche gesamt</span></div>
      <div class="stat-card"><span class="stat-value" id="sv-unique">â€“</span><span class="stat-label">Unique heute</span></div>
      <div class="stat-card"><span class="stat-value" id="sv-polls">â€“</span><span class="stat-label">Umfrage-Stimmen</span></div>
      <div class="stat-card"><span class="stat-value" id="sv-quiz">â€“</span><span class="stat-label">Quiz-Antworten</span></div>
      <div class="stat-card"><span class="stat-value" id="sv-feedback">â€“</span><span class="stat-label">RÃ¼ckmeldungen</span></div>
    </div>
    <section class="panel">
      <div class="panel-header"><h2>ğŸ“ˆ Besuche pro Tag</h2><span class="badge" id="daily-avg"></span></div>
      <div id="daily-chart"></div>
    </section>
  </div>

  <!-- â•â•â• Tab: Candidates â•â•â• -->
  <div class="tab-panel" id="tab-candidates">
    <!-- Register new candidate -->
    <section class="panel">
      <div class="panel-header"><h2>â• Neuen Kandidaten anlegen</h2></div>
      <div class="register-form">
        <div class="two-col">
          <div>
            <div class="fg">
              <label for="reg-name">Name</label>
              <input type="text" id="reg-name" placeholder="Max Mustermann">
            </div>
            <div class="fg">
              <label for="reg-slug">URL-KÃ¼rzel</label>
              <input type="text" id="reg-slug" placeholder="maxmustermann" pattern="[a-z0-9\-]+" maxlength="40">
              <p class="hint">Kleinbuchstaben, Zahlen, Bindestriche. Wird Teil der URL.</p>
            </div>
          </div>
          <div>
            <div class="fg">
              <label for="reg-user">Admin-Benutzername</label>
              <input type="text" id="reg-user" placeholder="admin" autocomplete="off">
            </div>
            <div class="fg">
              <label for="reg-pass">Admin-Passwort</label>
              <input type="password" id="reg-pass" placeholder="Mind. 6 Zeichen" autocomplete="off">
            </div>
          </div>
        </div>
        <button class="save-btn" id="register-btn">Kandidat erstellen</button>
        <div class="form-msg" id="reg-msg"></div>
      </div>
    </section>

    <!-- Candidates table -->
    <section class="panel">
      <div class="panel-header"><h2>ğŸ‘¥ Kandidaten</h2><span class="badge" id="cand-badge"></span></div>
      <div style="overflow-x:auto">
        <table id="tbl-candidates">
          <thead><tr><th>Kandidat</th><th style="text-align:right">Besuche</th><th style="text-align:right">Umfragen</th><th style="text-align:right">Quiz</th><th style="text-align:right">Feedback</th><th style="text-align:right">Seiten</th><th></th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>
  </div>

  <!-- â•â•â• Tab: Settings â•â•â• -->
  <div class="tab-panel" id="tab-settings">
    <section class="panel">
      <div class="panel-header"><h2>âš™ï¸ Startseite konfigurieren</h2></div>
      <div class="settings-form" id="settings-form">
        <div class="two-col">
          <div>
            <div class="fg">
              <label for="s-site-title">Seitentitel</label>
              <input type="text" id="s-site-title" placeholder="Kommunalwahl 2026">
            </div>
            <div class="fg">
              <label for="s-site-subtitle">Untertitel / Slogan</label>
              <input type="text" id="s-site-subtitle" placeholder="Gemeinsam fÃ¼r unsere Gemeinde">
            </div>
            <div class="fg">
              <label for="s-hero-headline">Hero-Ãœberschrift</label>
              <input type="text" id="s-hero-headline" placeholder="Kommunalwahl 2026">
            </div>
            <div class="fg">
              <label for="s-hero-text">Hero-Text</label>
              <textarea id="s-hero-text" placeholder="Lernen Sie unsere Kandidaten kennenâ€¦"></textarea>
            </div>
          </div>
          <div>
            <div class="fg">
              <label for="s-campaign-title">Kampagne â€“ Titel</label>
              <input type="text" id="s-campaign-title" placeholder="Leer lassen um Banner auszublenden">
            </div>
            <div class="fg">
              <label for="s-campaign-text">Kampagne â€“ Text</label>
              <textarea id="s-campaign-text" placeholder="Optionaler Beschreibungstext"></textarea>
            </div>
            <div class="fg">
              <label for="s-footer-text">Footer-Text</label>
              <input type="text" id="s-footer-text" placeholder="Wahl 2026 Â· macherwerkstatt.cc">
            </div>
          </div>
        </div>
        <div style="border-top:1px solid var(--border);padding-top:1.25rem;margin-top:.75rem">
          <div style="display:flex;flex-wrap:wrap;gap:1.5rem;align-items:flex-start">
            <div class="fg" style="flex:1;min-width:220px">
              <label style="display:flex;align-items:center;gap:.5rem;cursor:pointer">
                <input type="checkbox" id="s-show-candidates" style="width:18px;height:18px;accent-color:var(--primary)">
                Kandidaten auf Startseite anzeigen
              </label>
              <small style="color:var(--text-secondary);margin-top:.25rem;display:block">Wenn deaktiviert, wird die Kandidatenliste auf der Startseite ausgeblendet.</small>
            </div>
            <div class="fg" style="flex:1;min-width:220px">
              <label for="s-redirect-url">Startseite umleiten (Redirect)</label>
              <input type="url" id="s-redirect-url" placeholder="https://... (leer = keine Umleitung)">
              <small style="color:var(--text-secondary);margin-top:.25rem;display:block">Wenn eine URL eingetragen ist, wird die Startseite dorthin weitergeleitet. Alle anderen Einstellungen haben dann keine Wirkung.</small>
            </div>
          </div>
        </div>
        <button class="save-btn" id="save-settings-btn">Speichern</button>
        <div class="form-msg" id="settings-msg"></div>
      </div>
    </section>
  </div>

  <!-- â•â•â• Tab: Data â•â•â• -->
  <div class="tab-panel" id="tab-data">
    <section class="panel">
      <div class="panel-header"><h2>ğŸ—„ï¸ Datenbank</h2></div>
      <div style="display:flex;gap:1.5rem;flex-wrap:wrap;align-items:flex-start">
        <div>
          <h3 style="font-size:.9rem;margin-bottom:.5rem">Export</h3>
          <div class="exports-row">
            <button class="export-btn primary" id="btn-export-db">ğŸ—„ï¸ Datenbank herunterladen</button>
          </div>
        </div>
        <div>
          <h3 style="font-size:.9rem;margin-bottom:.5rem">Import</h3>
          <div class="upload-card" id="uc-db-import">
            <h3>Datenbank importieren</h3>
            <p>SQLite .db Â· Ersetzt die gesamte Datenbank</p>
            <input type="file" accept=".db" class="upload-input" id="file-db-import">
            <label for="file-db-import" class="upload-label">ğŸ“¥ Datei wÃ¤hlen</label>
            <div class="upload-status" id="status-db-import"></div>
          </div>
        </div>
      </div>
    </section>
    <section class="panel">
      <div class="panel-header"><h2>ğŸŒ GeoIP Datenbank</h2></div>
      <div class="upload-card" id="uc-geoip" style="max-width:400px">
        <h3>GeoLite2-City Datenbank</h3>
        <p>GeoLite2-City.mmdb Â· max. 150 MB Â· gilt fÃ¼r alle Kandidaten</p>
        <input type="file" accept=".mmdb" class="upload-input" id="file-geoip">
        <label for="file-geoip" class="upload-label">ğŸŒ Datei wÃ¤hlen</label>
        <div class="upload-status" id="status-geoip"></div>
      </div>
    </section>
  </div>
</div>

<script>
(function(){
"use strict";
var auth="";
var STORE_KEY="wahl_platform_admin";

// â”€â”€ Tabs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.querySelectorAll(".tab-btn").forEach(function(b){
  b.addEventListener("click",function(){
    document.querySelectorAll(".tab-btn").forEach(function(t){t.classList.remove("active")});
    document.querySelectorAll(".tab-panel").forEach(function(p){p.classList.remove("active")});
    b.classList.add("active");
    document.getElementById("tab-"+b.dataset.tab).classList.add("active");
    // Load settings when switching to that tab
    if(b.dataset.tab==="settings") loadSettings();
  });
});

// â”€â”€ Login â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var loginBtn=document.getElementById("login-btn");
var passInput=document.getElementById("pass");
var userInput=document.getElementById("user");
loginBtn.addEventListener("click",doLogin);
passInput.addEventListener("keydown",function(e){if(e.key==="Enter")doLogin()});
userInput.addEventListener("keydown",function(e){if(e.key==="Enter")passInput.focus()});

var saved=localStorage.getItem(STORE_KEY);
if(saved){auth=saved;apiFetch("/platform/stats").then(function(d){
  showDash();renderStats(d);
}).catch(function(){localStorage.removeItem(STORE_KEY);auth=""});}

document.getElementById("logout-btn").addEventListener("click",function(e){
  e.preventDefault();localStorage.removeItem(STORE_KEY);auth="";
  document.getElementById("dashboard-view").hidden=true;document.getElementById("login-view").hidden=false;
  userInput.value="";passInput.value="";document.getElementById("login-error").hidden=true;
  loginBtn.textContent="Anmelden";loginBtn.disabled=false;
});

function doLogin(){
  var u=userInput.value,p=passInput.value;auth="Basic "+btoa(u+":"+p);
  loginBtn.textContent="Ladenâ€¦";loginBtn.disabled=true;
  apiFetch("/platform/stats").then(function(d){
    localStorage.setItem(STORE_KEY,auth);showDash();renderStats(d);
  }).catch(function(){
    document.getElementById("login-error").hidden=false;
    loginBtn.textContent="Anmelden";loginBtn.disabled=false;auth="";
  });
}

function showDash(){document.getElementById("login-view").hidden=true;document.getElementById("dashboard-view").hidden=false}

function apiFetch(url,opts){
  opts=opts||{};opts.headers=Object.assign({"Authorization":auth},opts.headers||{});
  return fetch("/api"+url,opts).then(function(r){if(!r.ok)throw new Error(r.status);return r.json()});
}

// â”€â”€ Stats â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderStats(d){
  document.getElementById("sv-candidates").textContent=num(d.candidate_count);
  document.getElementById("sv-visits").textContent=num(d.total_visits);
  document.getElementById("sv-unique").textContent=num(d.unique_today);
  document.getElementById("sv-polls").textContent=num(d.total_polls);
  document.getElementById("sv-quiz").textContent=num(d.total_quiz);
  document.getElementById("sv-feedback").textContent=num(d.total_feedback);
  document.getElementById("cand-badge").textContent=d.candidate_count+" registriert";
  renderDaily(d.daily);renderCandidates(d.candidates);
}

function num(n){return(n||0).toLocaleString("de-DE")}

function renderDaily(daily){
  var c=document.getElementById("daily-chart"),avg=document.getElementById("daily-avg");
  if(!daily||!daily.length){c.innerHTML='<p class="empty">Keine Daten</p>';avg.textContent="";return}
  var max=Math.max.apply(null,daily.map(function(d){return d.total}));
  var sum=daily.reduce(function(s,d){return s+d.total},0);
  avg.textContent="Ã˜ "+Math.round(sum/daily.length)+"/Tag";
  c.innerHTML=daily.map(function(d){var pct=max?Math.round(d.total/max*100):0;var ds=d.day.length>5?d.day.substring(5):d.day;
    return '<div class="bar-row"><div class="bar-top"><span class="bar-label">'+esc(ds)+'</span><span class="bar-value">'+d.total+' <span style="color:#aaa">('+d.uniq+' uniq)</span></span></div><div class="bar-track"><div class="bar-fill" style="width:'+pct+'%"></div></div></div>';
  }).join("");
}

function renderCandidates(candidates){
  var tb=document.querySelector("#tbl-candidates tbody");
  if(!candidates||!candidates.length){tb.innerHTML='<tr><td colspan="7" class="empty">Keine Kandidaten</td></tr>';return}
  tb.innerHTML=candidates.map(function(c){
    return '<tr>'+
      '<td><span class="candidate-color" style="background:'+esc(c.theme_color)+'"></span><strong>'+esc(c.name)+'</strong><span class="mini">'+esc(c.party||"â€“")+' Â· /'+esc(c.slug)+'/</span></td>'+
      '<td style="text-align:right">'+num(c.visits)+'</td>'+
      '<td style="text-align:right">'+num(c.polls)+'</td>'+
      '<td style="text-align:right">'+num(c.quiz)+'</td>'+
      '<td style="text-align:right">'+num(c.feedback)+'</td>'+
      '<td style="text-align:right">'+c.pages+'</td>'+
      '<td><a href="/'+esc(c.slug)+'/admin/" class="btn-link" style="font-size:.78rem">Admin â†’</a></td>'+
      '</tr>';
  }).join("");
}

// â”€â”€ Register â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById("reg-name").addEventListener("input",function(){
  var slug=this.value.toLowerCase()
    .replace(/[Ã¤Ã„]/g,"ae").replace(/[Ã¶Ã–]/g,"oe").replace(/[Ã¼Ãœ]/g,"ue").replace(/[ÃŸ]/g,"ss")
    .replace(/[^a-z0-9]+/g,"").substring(0,40);
  document.getElementById("reg-slug").value=slug;
});

var regBtn=document.getElementById("register-btn");
var regMsg=document.getElementById("reg-msg");
regBtn.addEventListener("click",function(){
  var name=document.getElementById("reg-name").value.trim();
  var slug=document.getElementById("reg-slug").value.trim();
  var user=document.getElementById("reg-user").value.trim();
  var pass=document.getElementById("reg-pass").value;
  regMsg.textContent="";
  if(!name||!slug||!user||!pass){fm(regMsg,"Bitte alle Felder ausfÃ¼llen.","err");return}
  if(!/^[a-z0-9\-]+$/.test(slug)){fm(regMsg,"URL-KÃ¼rzel: nur Kleinbuchstaben, Zahlen, Bindestriche.","err");return}
  if(pass.length<6){fm(regMsg,"Passwort mind. 6 Zeichen.","err");return}
  regBtn.disabled=true;regBtn.textContent="Erstelleâ€¦";
  fetch("/api/register",{
    method:"POST",
    headers:{"Content-Type":"application/json","Authorization":auth},
    body:JSON.stringify({name:name,slug:slug,admin_user:user,admin_pass:pass})
  }).then(function(r){return r.json().then(function(d){return{ok:r.ok,data:d}})})
  .then(function(res){
    if(res.ok){
      fm(regMsg,'âœ… Kandidat \u201E'+name+'\u201C erstellt! \u2192 /'+slug+'/','ok');
      document.getElementById("reg-name").value="";document.getElementById("reg-slug").value="";
      document.getElementById("reg-user").value="";document.getElementById("reg-pass").value="";
      // Reload candidates
      apiFetch("/platform/stats").then(renderStats).catch(function(){});
    } else {
      fm(regMsg,res.data.detail||"Fehler","err");
    }
    regBtn.disabled=false;regBtn.textContent="Kandidat erstellen";
  }).catch(function(){
    fm(regMsg,"Netzwerkfehler","err");regBtn.disabled=false;regBtn.textContent="Kandidat erstellen";
  });
});

// â”€â”€ Settings â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var settingsLoaded=false;
function loadSettings(){
  if(settingsLoaded)return;
  apiFetch("/platform/settings").then(function(d){
    settingsLoaded=true;
    document.getElementById("s-site-title").value=d.site_title||"";
    document.getElementById("s-site-subtitle").value=d.site_subtitle||"";
    document.getElementById("s-hero-headline").value=d.hero_headline||"";
    document.getElementById("s-hero-text").value=d.hero_text||"";
    document.getElementById("s-campaign-title").value=d.campaign_title||"";
    document.getElementById("s-campaign-text").value=d.campaign_text||"";
    document.getElementById("s-footer-text").value=d.footer_text||"";
    document.getElementById("s-show-candidates").checked=(d.show_candidates!=="0");
    document.getElementById("s-redirect-url").value=d.redirect_url||"";
  }).catch(function(){});
}

var saveBtn=document.getElementById("save-settings-btn");
var settingsMsg=document.getElementById("settings-msg");
saveBtn.addEventListener("click",function(){
  var payload={
    site_title:document.getElementById("s-site-title").value,
    site_subtitle:document.getElementById("s-site-subtitle").value,
    hero_headline:document.getElementById("s-hero-headline").value,
    hero_text:document.getElementById("s-hero-text").value,
    campaign_title:document.getElementById("s-campaign-title").value,
    campaign_text:document.getElementById("s-campaign-text").value,
    footer_text:document.getElementById("s-footer-text").value,
    show_candidates:document.getElementById("s-show-candidates").checked?"1":"0",
    redirect_url:document.getElementById("s-redirect-url").value.trim(),
  };
  saveBtn.disabled=true;saveBtn.textContent="Speichernâ€¦";settingsMsg.textContent="";
  fetch("/api/platform/settings",{
    method:"PUT",
    headers:{"Content-Type":"application/json","Authorization":auth},
    body:JSON.stringify(payload)
  }).then(function(r){if(!r.ok)throw new Error();return r.json()})
  .then(function(){
    fm(settingsMsg,"âœ… Gespeichert! Startseite aktualisiert.","ok");
    saveBtn.disabled=false;saveBtn.textContent="Speichern";
    settingsLoaded=false; // reload on next visit
  }).catch(function(){
    fm(settingsMsg,"âŒ Fehler beim Speichern","err");
    saveBtn.disabled=false;saveBtn.textContent="Speichern";
  });
});

// â”€â”€ DB Export â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById("btn-export-db").addEventListener("click",function(){
  fetch("/api/platform/export/db",{headers:{"Authorization":auth}})
  .then(function(r){if(!r.ok)throw new Error();return r.blob()})
  .then(function(blob){var u=URL.createObjectURL(blob);var a=document.createElement("a");a.href=u;a.download="wahl2026_backup.db";a.click();URL.revokeObjectURL(u)})
  .catch(function(){alert("Export fehlgeschlagen")});
});

// â”€â”€ DB Import â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var dbInput=document.getElementById("file-db-import");
var dbStatus=document.getElementById("status-db-import");
var dbCard=document.getElementById("uc-db-import");
dbInput.addEventListener("change",function(){if(dbInput.files.length)doImportDB(dbInput.files[0])});
dbCard.addEventListener("dragover",function(e){e.preventDefault();dbCard.classList.add("dragover")});
dbCard.addEventListener("dragleave",function(){dbCard.classList.remove("dragover")});
dbCard.addEventListener("drop",function(e){e.preventDefault();dbCard.classList.remove("dragover");if(e.dataTransfer.files.length)doImportDB(e.dataTransfer.files[0])});

function doImportDB(file){
  if(!file.name.endsWith(".db")){dbStatus.className="upload-status err";dbStatus.textContent="âŒ Nur .db Dateien erlaubt";return}
  if(!confirm("âš ï¸ Die gesamte Datenbank wird ersetzt! Fortfahren?")){return}
  dbStatus.className="upload-status";dbStatus.textContent="Hochladenâ€¦ ("+fmtB(file.size)+")";
  var fd=new FormData();fd.append("file",file);
  fetch("/api/platform/import/db",{method:"POST",headers:{"Authorization":auth},body:fd})
  .then(function(r){if(!r.ok)return r.json().then(function(d){throw new Error(d.detail||"Fehler")});return r.json()})
  .then(function(d){
    dbStatus.className="upload-status ok";
    dbStatus.textContent="âœ… Import OK ("+d.tables.length+" Tabellen, "+fmtB(d.size)+")";
    apiFetch("/platform/stats").then(renderStats).catch(function(){});
  })
  .catch(function(err){dbStatus.className="upload-status err";dbStatus.textContent="âŒ "+err.message});
}

// â”€â”€ GeoIP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var geoInput=document.getElementById("file-geoip");
var geoStatus=document.getElementById("status-geoip");
var geoCard=document.getElementById("uc-geoip");
geoInput.addEventListener("change",function(){if(geoInput.files.length)doUploadGeoip(geoInput.files[0])});
geoCard.addEventListener("dragover",function(e){e.preventDefault();geoCard.classList.add("dragover")});
geoCard.addEventListener("dragleave",function(){geoCard.classList.remove("dragover")});
geoCard.addEventListener("drop",function(e){e.preventDefault();geoCard.classList.remove("dragover");if(e.dataTransfer.files.length)doUploadGeoip(e.dataTransfer.files[0])});
function doUploadGeoip(file){
  if(!file.name.endsWith(".mmdb")){geoStatus.className="upload-status err";geoStatus.textContent="âŒ Nur .mmdb";return}
  geoStatus.className="upload-status";geoStatus.textContent="Hochladenâ€¦ ("+fmtB(file.size)+")";
  var fd=new FormData();fd.append("file",file);
  fetch("/api/platform/upload/geoip",{method:"POST",headers:{"Authorization":auth},body:fd})
  .then(function(r){if(!r.ok)return r.json().then(function(d){throw new Error(d.detail||"Fehler")});return r.json()})
  .then(function(d){geoStatus.className="upload-status ok";geoStatus.textContent="âœ… "+d.file+" ("+fmtB(d.size)+")"+(d.loaded?" Â· geladen":" Â· nicht geladen")})
  .catch(function(err){geoStatus.className="upload-status err";geoStatus.textContent="âŒ "+err.message});
}

// â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function fmtB(b){if(b<1024)return b+" B";if(b<1048576)return(b/1024).toFixed(1)+" KB";return(b/1048576).toFixed(1)+" MB"}
function esc(s){var d=document.createElement("div");d.textContent=String(s);return d.innerHTML}
function fm(el,text,cls){el.textContent=text;el.className="form-msg "+cls}
})();
</script>
</body>
</html>
