<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Plattform-Admin Â· {{ get_platform_settings().site_title or 'Wahlplattform' }}</title>
<link rel="icon" type="image/svg+xml" href="/assets/img/favicon.svg">
<meta name="theme-color" content="#7c3aed">
<style>
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;background:#f0f2f5;color:#1d1d1f;min-height:100vh}
#login-view{display:flex;align-items:center;justify-content:center;min-height:100vh}
.login-card{background:#fff;padding:2.5rem;border-radius:16px;box-shadow:0 4px 24px rgba(0,0,0,.08);width:100%;max-width:380px}
.login-card h1{font-size:1.6rem;margin-bottom:.15rem;font-weight:700}
.login-card p.sub{color:#6e6e73;font-size:.85rem;margin-bottom:1.5rem}
.login-card input{display:block;width:100%;padding:.85rem 1rem;border:1.5px solid #e0e0e0;border-radius:10px;font-size:1rem;margin-bottom:.75rem;transition:border-color .2s}
.login-card input:focus{outline:none;border-color:#7c3aed;box-shadow:0 0 0 3px rgba(124,58,237,.12)}
.login-card button{display:block;width:100%;padding:.85rem;background:linear-gradient(135deg,#7c3aed,#6d28d9);color:#fff;border:none;border-radius:10px;font-size:1rem;cursor:pointer;font-weight:600}
.login-card button:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(124,58,237,.25)}
.error{color:#dc2626;font-size:.85rem;margin-top:.5rem;text-align:center}
#dashboard-view{max-width:1060px;margin:0 auto;padding:1.5rem 1rem 3rem}
[hidden]{display:none!important}
.dash-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:1.5rem;flex-wrap:wrap;gap:1rem}
.dash-header h1{font-size:1.6rem;font-weight:700}
.dash-header .sub{color:#6e6e73;font-size:.85rem;margin-top:.15rem}
.controls{display:flex;align-items:center;gap:.75rem;flex-wrap:wrap}
.btn-link{color:#7c3aed;text-decoration:none;font-size:.9rem;font-weight:500}
.btn-link:hover{text-decoration:underline}
/* Tabs */
.tab-bar{display:flex;gap:.25rem;border-bottom:2px solid #e0e0e0;margin-bottom:1.5rem;overflow-x:auto}
.tab-btn{padding:.65rem 1.1rem;background:none;border:none;border-bottom:2px solid transparent;margin-bottom:-2px;cursor:pointer;font-size:.88rem;font-weight:600;color:#6e6e73;white-space:nowrap;font-family:inherit;transition:color .15s,border-color .15s}
.tab-btn.active{color:#7c3aed;border-bottom-color:#7c3aed}
.tab-btn:hover{color:#1d1d1f}
.tab-panel{display:none}.tab-panel.active{display:block}
/* Stats */
.stats-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:.75rem;margin-bottom:1.5rem}
.stat-card{background:#fff;padding:1.25rem;border-radius:14px;box-shadow:0 1px 4px rgba(0,0,0,.05);text-align:center;border-top:3px solid var(--sc,#7c3aed)}
.stat-card:nth-child(1){--sc:#7c3aed}.stat-card:nth-child(2){--sc:#1E6FB9}.stat-card:nth-child(3){--sc:#D97706}.stat-card:nth-child(4){--sc:#16a34a}.stat-card:nth-child(5){--sc:#B91C1C}.stat-card:nth-child(6){--sc:#0891b2}
.stat-value{display:block;font-size:2.2rem;font-weight:800;color:var(--sc,#7c3aed);line-height:1.2}
.stat-label{display:block;font-size:.78rem;color:#6e6e73;margin-top:.35rem;text-transform:uppercase;letter-spacing:.04em;font-weight:500}
/* Panels */
.panel{background:#fff;border-radius:14px;padding:1.5rem;box-shadow:0 1px 4px rgba(0,0,0,.05);margin-bottom:1rem}
.panel-header{display:flex;justify-content:space-between;align-items:center;margin-bottom:1rem;flex-wrap:wrap;gap:.5rem}
.panel-header h2{font-size:1.15rem;font-weight:700}
.badge{background:#f0f2f5;padding:.2rem .65rem;border-radius:6px;font-size:.75rem;color:#6e6e73;font-weight:600}
/* Table */
table{width:100%;border-collapse:collapse}
th,td{padding:.6rem .75rem;text-align:left;border-bottom:1px solid #f0f0f2;font-size:.88rem}
th{font-weight:600;color:#8e8e93;font-size:.75rem;text-transform:uppercase;letter-spacing:.04em}
tbody tr:hover{background:#fafbfc}
td .mini{font-size:.72rem;color:#8e8e93;display:block;margin-top:.1rem}
/* Charts */
.bar-row{margin-bottom:.75rem}
.bar-top{display:flex;justify-content:space-between;align-items:baseline;margin-bottom:.3rem}
.bar-label{font-size:.84rem;color:#3a3a3c;line-height:1.3}
.bar-value{font-size:.8rem;color:#6e6e73;white-space:nowrap;font-weight:500}
.bar-track{width:100%;height:22px;background:#f0f2f5;border-radius:6px;overflow:hidden}
.bar-fill{height:100%;border-radius:6px;transition:width .5s;min-width:2px;background:var(--bar-color,#7c3aed)}
/* Buttons & Forms */
.export-btn{padding:.55rem 1.1rem;background:#fff;border:1.5px solid #e0e0e0;border-radius:10px;cursor:pointer;font-size:.82rem;font-weight:500;transition:all .15s;display:inline-flex;align-items:center;gap:.4rem;font-family:inherit}
.export-btn:hover{background:#f5f5f7;border-color:#c0c0c0}
.export-btn.primary{background:linear-gradient(135deg,#7c3aed,#6d28d9);color:#fff;border-color:transparent}
.export-btn.primary:hover{opacity:.92}
.export-btn.green{background:linear-gradient(135deg,#16a34a,#15803d);color:#fff;border-color:transparent}
.export-btn.green:hover{opacity:.92}
.exports-row{display:flex;flex-wrap:wrap;gap:.5rem;align-items:center}
/* Upload */
.upload-card{background:#fafbfc;border-radius:12px;padding:1.25rem;border:1.5px dashed #d0d0d0;text-align:center;transition:border-color .2s;max-width:400px}
.upload-card:hover{border-color:#7c3aed;background:#f5f3ff}
.upload-card.dragover{border-color:#7c3aed;background:#ede9fe}
.upload-card h3{font-size:.95rem;margin-bottom:.25rem}
.upload-card p{font-size:.78rem;color:#8e8e93;margin-bottom:.75rem}
.upload-input{display:none}
.upload-label{display:inline-block;padding:.55rem 1.2rem;background:linear-gradient(135deg,#16a34a,#15803d);color:#fff;border-radius:10px;cursor:pointer;font-size:.82rem;font-weight:600}
.upload-label:hover{transform:translateY(-1px);opacity:.92}
.upload-status{font-size:.78rem;margin-top:.5rem;min-height:1.2em;color:#6e6e73}
.upload-status.ok{color:#16a34a}.upload-status.err{color:#dc2626}
.candidate-color{display:inline-block;width:12px;height:12px;border-radius:3px;margin-right:.4rem;vertical-align:middle}
.empty{color:#8e8e93;font-size:.88rem;font-style:italic;padding:.5rem 0}
/* Settings Form */
.settings-form .fg{margin-bottom:1rem}
.settings-form label{display:block;font-size:.82rem;font-weight:600;margin-bottom:.3rem;color:#3a3a3c}
.settings-form input,.settings-form textarea{display:block;width:100%;padding:.7rem .9rem;border:1.5px solid #e0e0e0;border-radius:8px;font-size:.92rem;font-family:inherit;transition:border-color .2s}
.settings-form input:focus,.settings-form textarea:focus{outline:none;border-color:#7c3aed;box-shadow:0 0 0 3px rgba(124,58,237,.1)}
.settings-form textarea{min-height:60px;resize:vertical}
.save-btn{padding:.65rem 1.5rem;background:linear-gradient(135deg,#7c3aed,#6d28d9);color:#fff;border:none;border-radius:10px;font-size:.92rem;cursor:pointer;font-weight:600;font-family:inherit}
.save-btn:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(124,58,237,.25)}
.save-btn:disabled{opacity:.6;cursor:default;transform:none}
.form-msg{font-size:.82rem;margin-top:.5rem;min-height:1.2em}
.form-msg.ok{color:#16a34a}.form-msg.err{color:#dc2626}
/* Register */
.register-form .fg{margin-bottom:.85rem}
.register-form label{display:block;font-size:.82rem;font-weight:600;margin-bottom:.3rem;color:#3a3a3c}
.register-form input{display:block;width:100%;padding:.7rem .9rem;border:1.5px solid #e0e0e0;border-radius:8px;font-size:.92rem;font-family:inherit;transition:border-color .2s}
.register-form input:focus{outline:none;border-color:#7c3aed;box-shadow:0 0 0 3px rgba(124,58,237,.1)}
.register-form .hint{font-size:.72rem;color:#8e8e93;margin-top:.2rem}
.two-col{display:grid;grid-template-columns:1fr 1fr;gap:1.5rem}
.btn-danger{padding:.3rem .6rem;background:#fee2e2;color:#dc2626;border:1px solid #fca5a5;border-radius:6px;cursor:pointer;font-size:.72rem;font-weight:600;font-family:inherit;transition:all .15s}
.btn-danger:hover{background:#dc2626;color:#fff}
.btn-sm{padding:.25rem .5rem;background:#f0f2f5;color:#3a3a3c;border:1px solid #d0d0d0;border-radius:6px;cursor:pointer;font-size:.78rem;font-family:inherit;transition:all .15s;line-height:1}
.btn-sm:hover{background:#e0e2e5;border-color:#b0b0b0}
.btn-sm-import{background:#f0fdf4;color:#16a34a;border-color:#86efac}
.btn-sm-import:hover{background:#16a34a;color:#fff}
.btn-sm-stats{background:#eff6ff;color:#2563eb;border-color:#93c5fd}
.btn-sm-stats:hover{background:#2563eb;color:#fff}
.cand-dropdown{position:relative;display:inline-block}
.cand-dropdown-menu{display:none;position:absolute;right:0;top:100%;background:#fff;border:1px solid #e0e0e0;border-radius:8px;box-shadow:0 4px 16px rgba(0,0,0,.12);z-index:50;min-width:200px;padding:.35rem 0;margin-top:.2rem}
.cand-dropdown-menu.open{display:block}
.cand-dropdown-menu button{display:block;width:100%;text-align:left;padding:.5rem .9rem;border:none;background:none;cursor:pointer;font-size:.8rem;font-family:inherit;color:#1d1d1f;transition:background .1s}
.cand-dropdown-menu button:hover{background:#f5f5f7}
.cand-dropdown-menu button.text-red{color:#dc2626}
.cand-dropdown-menu button.text-red:hover{background:#fef2f2}
.cand-dropdown-menu hr{border:none;border-top:1px solid #e5e5ea;margin:.25rem 0}
@media(max-width:700px){.stats-grid{grid-template-columns:repeat(2,1fr)}.two-col{grid-template-columns:1fr}}
@media(max-width:480px){
  #dashboard-view{padding:1rem .75rem 2rem}
  .login-card{padding:1.75rem 1.25rem;margin:0 .75rem}
  .login-card h1{font-size:1.3rem}
  .dash-header{margin-bottom:1rem}
  .dash-header h1{font-size:1.25rem}
  .tab-bar{gap:0;-webkit-overflow-scrolling:touch}
  .tab-btn{padding:.55rem .75rem;font-size:.78rem}
  .stats-grid{grid-template-columns:repeat(2,1fr);gap:.5rem}
  .stat-value{font-size:1.6rem}
  .stat-label{font-size:.68rem}
  .stat-card{padding:.85rem .6rem}
  .panel{padding:1rem .85rem;border-radius:10px}
  .panel-header h2{font-size:1rem}
  table{font-size:.78rem}
  th,td{padding:.45rem .4rem}
  td .mini{font-size:.65rem}
  .export-btn{padding:.45rem .75rem;font-size:.75rem}
  .exports-row{gap:.35rem}
  .btn-danger{font-size:.65rem;padding:.25rem .45rem}
  .btn-sm{font-size:.7rem;padding:.2rem .35rem}
  .settings-form input,.settings-form textarea{font-size:.85rem;padding:.6rem .7rem}
  .settings-form label{font-size:.78rem}
  .save-btn{font-size:.85rem;padding:.55rem 1.1rem}
  .register-form input{font-size:.85rem;padding:.6rem .7rem}
  .register-form label{font-size:.78rem}
  .upload-card{padding:1rem}
  .upload-card h3{font-size:.85rem}
  .cand-dropdown-menu{min-width:170px}
  .cand-dropdown-menu button{font-size:.75rem;padding:.4rem .7rem}
  .controls{gap:.5rem}
  .btn-link{font-size:.78rem}
}
</style>
</head>
<body>
<div id="login-view">
  <div class="login-card">
    <h1>ğŸ”§ Plattform-Admin</h1>
    <p class="sub">{{ get_platform_settings().site_title or 'Wahlplattform' }} Â· Gesamtverwaltung</p>
    <input type="text" id="user" placeholder="Benutzer" autocomplete="username" autofocus>
    <input type="password" id="pass" placeholder="Passwort" autocomplete="current-password">
    <button id="login-btn">Anmelden</button>
    <p id="login-error" class="error" hidden>UngÃ¼ltige Zugangsdaten</p>
  </div>
</div>

<div id="dashboard-view" hidden>
  <div class="dash-header">
    <div>
      <h1>ğŸ”§ Plattform-Admin</h1>
      <p class="sub">{{ get_platform_settings().site_title or 'Wahlplattform' }} Â· GesamtÃ¼bersicht</p>
    </div>
    <div class="controls">
      <a href="/" class="btn-link">ğŸ  Startseite</a>
      <a href="#" class="btn-link" id="logout-btn" style="color:#dc2626">Abmelden</a>
    </div>
  </div>

  <!-- Tab Bar -->
  <div class="tab-bar">
    <button class="tab-btn active" data-tab="stats">ğŸ“Š Statistiken</button>
    <button class="tab-btn" data-tab="candidates">ğŸ‘¥ Kandidaten</button>
    <button class="tab-btn" data-tab="settings">âš™ï¸ Startseite</button>
    <button class="tab-btn" data-tab="wahlinfo">â„¹ï¸ Wahlinfo</button>
    <button class="tab-btn" data-tab="smtp">ğŸ“§ E-Mail</button>
    <button class="tab-btn" data-tab="data">ğŸ—„ï¸ Daten</button>
  </div>

  <!-- â•â•â• Tab: Stats â•â•â• -->
  <div class="tab-panel active" id="tab-stats">
    <div class="stats-grid">
      <div class="stat-card"><span class="stat-value" id="sv-candidates">â€“</span><span class="stat-label">Kandidaten</span></div>
      <div class="stat-card"><span class="stat-value" id="sv-visits">â€“</span><span class="stat-label">Besuche gesamt</span></div>
      <div class="stat-card"><span class="stat-value" id="sv-unique">â€“</span><span class="stat-label">Unique heute</span></div>
      <div class="stat-card"><span class="stat-value" id="sv-polls">â€“</span><span class="stat-label">Umfrage-Stimmen</span></div>
      <div class="stat-card"><span class="stat-value" id="sv-quiz">â€“</span><span class="stat-label">Quiz-Antworten</span></div>
      <div class="stat-card"><span class="stat-value" id="sv-feedback">â€“</span><span class="stat-label">RÃ¼ckmeldungen</span></div>
    </div>
    <section class="panel">
      <div class="panel-header"><h2>ğŸ“ˆ Besuche pro Tag</h2><span class="badge" id="daily-avg"></span></div>
      <div id="daily-chart"></div>
    </section>
  </div>

  <!-- â•â•â• Tab: Candidates â•â•â• -->
  <div class="tab-panel" id="tab-candidates">
    <!-- Register new candidate -->
    <section class="panel">
      <div class="panel-header"><h2>â• Neuen Kandidaten anlegen</h2></div>
      <div class="register-form">
        <div class="two-col">
          <div>
            <div class="fg">
              <label for="reg-name">Name</label>
              <input type="text" id="reg-name" placeholder="Max Mustermann">
            </div>
            <div class="fg">
              <label for="reg-slug">URL-KÃ¼rzel</label>
              <input type="text" id="reg-slug" placeholder="maxmustermann" pattern="[a-z0-9\-]+" maxlength="40">
              <p class="hint">Kleinbuchstaben, Zahlen, Bindestriche. Wird Teil der URL.</p>
            </div>
          </div>
          <div>
            <div class="fg">
              <label for="reg-user">Admin-Benutzername</label>
              <input type="text" id="reg-user" placeholder="admin" autocomplete="off">
            </div>
            <div class="fg">
              <label for="reg-pass">Admin-Passwort</label>
              <input type="password" id="reg-pass" placeholder="Mind. 6 Zeichen" autocomplete="off">
            </div>
          </div>
        </div>
        <button class="save-btn" id="register-btn">Kandidat erstellen</button>
        <div class="form-msg" id="reg-msg"></div>
      </div>
    </section>

    <!-- Candidates table -->
    <section class="panel">
      <div class="panel-header"><h2>ğŸ‘¥ Kandidaten</h2><span class="badge" id="cand-badge"></span></div>
      <div class="exports-row" style="margin-bottom:1rem">
        <button class="export-btn primary" id="btn-export-candidates">ğŸ“¥ Kandidaten exportieren (JSON)</button>
        <button class="export-btn green" id="btn-import-candidates-trigger">ğŸ“¤ Kandidaten importieren</button>
        <input type="file" accept=".json" id="file-candidates-import" style="display:none">
        <label style="display:flex;align-items:center;gap:.4rem;font-size:.78rem;color:#6e6e73;cursor:pointer">
          <input type="checkbox" id="import-overwrite" style="width:14px;height:14px">
          Bestehende Ã¼berschreiben
        </label>
      </div>
      <div class="form-msg" id="candidates-import-msg" style="margin-bottom:.5rem"></div>
      <div style="overflow-x:auto">
        <table id="tbl-candidates">
          <thead><tr><th>Kandidat</th><th style="text-align:right">Besuche</th><th style="text-align:right">Umfragen</th><th style="text-align:right">Quiz</th><th style="text-align:right">Feedback</th><th style="text-align:right">Seiten</th><th></th></tr></thead>
          <tbody></tbody>
        </table>
      </div>
    </section>
  </div>

  <!-- â•â•â• Tab: Settings â•â•â• -->
  <div class="tab-panel" id="tab-settings">
    <section class="panel">
      <div class="panel-header"><h2>âš™ï¸ Startseite konfigurieren</h2></div>
      <div class="settings-form" id="settings-form">
        <div class="two-col">
          <div>
            <div class="fg">
              <label for="s-site-title">Seitentitel</label>
              <input type="text" id="s-site-title" placeholder="z. B. Kommunalwahl 2026">
            </div>
            <div class="fg">
              <label for="s-site-subtitle">Untertitel / Slogan</label>
              <input type="text" id="s-site-subtitle" placeholder="Gemeinsam fÃ¼r unsere Gemeinde">
            </div>
            <div class="fg">
              <label for="s-hero-headline">Hero-Ãœberschrift</label>
              <input type="text" id="s-hero-headline" placeholder="z. B. Willkommen zur Wahl">
            </div>
            <div class="fg">
              <label for="s-hero-text">Hero-Text <span style="font-weight:400;font-size:.72rem;color:#8e8e93">Markdown: **fett**, [Link](URL), ![Bild](URL)</span></label>
              <div class="md-toolbar" style="display:flex;gap:.3rem;margin-bottom:.3rem"><button type="button" onclick="mdInsert('s-hero-text','link')" style="padding:.25rem .5rem;font-size:.78rem;border:1px solid #d0d0d0;border-radius:5px;background:#f5f5f7;cursor:pointer">ğŸ”— Link</button><button type="button" onclick="mdInsert('s-hero-text','image')" style="padding:.25rem .5rem;font-size:.78rem;border:1px solid #d0d0d0;border-radius:5px;background:#f5f5f7;cursor:pointer">ğŸ–¼ï¸ Bild</button><button type="button" onclick="mdInsert('s-hero-text','bold')" style="padding:.25rem .5rem;font-size:.78rem;border:1px solid #d0d0d0;border-radius:5px;background:#f5f5f7;cursor:pointer"><b>B</b></button><button type="button" onclick="mdInsert('s-hero-text','italic')" style="padding:.25rem .5rem;font-size:.78rem;border:1px solid #d0d0d0;border-radius:5px;background:#f5f5f7;cursor:pointer"><i>I</i></button></div>
              <textarea id="s-hero-text" placeholder="Lernen Sie unsere Kandidaten kennenâ€¦"></textarea>
            </div>
          </div>
          <div>
            <div class="fg">
              <label for="s-campaign-title">Kampagne â€“ Titel</label>
              <input type="text" id="s-campaign-title" placeholder="Leer lassen um Banner auszublenden">
            </div>
            <div class="fg">
              <label for="s-campaign-text">Kampagne â€“ Text <span style="font-weight:400;font-size:.72rem;color:#8e8e93">Markdown: **fett**, [Link](URL), ![Bild](URL)</span></label>
              <div class="md-toolbar" style="display:flex;gap:.3rem;margin-bottom:.3rem"><button type="button" onclick="mdInsert('s-campaign-text','link')" style="padding:.25rem .5rem;font-size:.78rem;border:1px solid #d0d0d0;border-radius:5px;background:#f5f5f7;cursor:pointer">ğŸ”— Link</button><button type="button" onclick="mdInsert('s-campaign-text','image')" style="padding:.25rem .5rem;font-size:.78rem;border:1px solid #d0d0d0;border-radius:5px;background:#f5f5f7;cursor:pointer">ğŸ–¼ï¸ Bild</button><button type="button" onclick="mdInsert('s-campaign-text','bold')" style="padding:.25rem .5rem;font-size:.78rem;border:1px solid #d0d0d0;border-radius:5px;background:#f5f5f7;cursor:pointer"><b>B</b></button><button type="button" onclick="mdInsert('s-campaign-text','italic')" style="padding:.25rem .5rem;font-size:.78rem;border:1px solid #d0d0d0;border-radius:5px;background:#f5f5f7;cursor:pointer"><i>I</i></button></div>
              <textarea id="s-campaign-text" placeholder="Optionaler Beschreibungstext"></textarea>
            </div>
            <div class="fg">
              <label for="s-footer-text">Footer-Text</label>
              <input type="text" id="s-footer-text" placeholder="z. B. Wahlplattform Â· meinedomain.de">
            </div>
          </div>
        </div>
        <div style="border-top:1px solid var(--border);padding-top:1.25rem;margin-top:.75rem">
          <div style="display:flex;flex-wrap:wrap;gap:1.5rem;align-items:flex-start">
            <div class="fg" style="flex:1;min-width:220px">
              <label style="display:flex;align-items:center;gap:.5rem;cursor:pointer">
                <input type="checkbox" id="s-show-candidates" style="width:18px;height:18px;accent-color:var(--primary)">
                Kandidaten auf Startseite anzeigen
              </label>
              <small style="color:var(--text-secondary);margin-top:.25rem;display:block">Wenn deaktiviert, wird die Kandidatenliste auf der Startseite ausgeblendet.</small>
            </div>
            <div class="fg" style="flex:1;min-width:220px">
              <label for="s-redirect-url">Startseite umleiten (Redirect)</label>
              <input type="url" id="s-redirect-url" placeholder="https://... (leer = keine Umleitung)">
              <small style="color:var(--text-secondary);margin-top:.25rem;display:block">Wenn eine URL eingetragen ist, wird die Startseite dorthin weitergeleitet. Alle anderen Einstellungen haben dann keine Wirkung.</small>
            </div>
          </div>
        </div>
        <button class="save-btn" id="save-settings-btn">Speichern</button>
        <div class="form-msg" id="settings-msg"></div>
      </div>
    </section>
  </div>

  <!-- â•â•â• Tab: Wahlinfo â•â•â• -->
  <div class="tab-panel" id="tab-wahlinfo">
    <section class="panel">
      <div class="panel-header"><h2>â„¹ï¸ Wahlinfo-Seite</h2></div>
      <p style="font-size:.85rem;color:var(--text-secondary);margin-bottom:1rem">
        Allgemeine Informationsseite Ã¼ber die Wahl. Erreichbar unter <code>/wahlinfo/</code>.
        Kann fÃ¼r Wahlablauf, Stimmzettel-ErklÃ¤rung, ParteiÃ¼bersicht etc. genutzt werden.
      </p>
      <div class="settings-form">
        <div style="display:flex;flex-wrap:wrap;gap:1.5rem;align-items:flex-start;margin-bottom:1rem">
          <div class="fg" style="flex:0 0 auto">
            <label style="display:flex;align-items:center;gap:.5rem;cursor:pointer">
              <input type="checkbox" id="s-wahlinfo-enabled" style="width:18px;height:18px;accent-color:var(--primary)">
              Wahlinfo-Seite aktivieren
            </label>
            <small style="color:var(--text-secondary);margin-top:.25rem;display:block">Wenn aktiviert, wird <a href="/wahlinfo/" target="_blank">/wahlinfo/</a> angezeigt und auf der Startseite verlinkt.</small>
          </div>
          <div class="fg" style="flex:1;min-width:220px">
            <label for="s-wahlinfo-title">Seitentitel</label>
            <input type="text" id="s-wahlinfo-title" placeholder="z. B. Wahlinfo oder So funktioniert die Wahl">
          </div>
        </div>
        <div class="fg">
          <label for="s-wahlinfo-content">Inhalt <span style="font-weight:400;font-size:.72rem;color:#8e8e93">Markdown: ## Ãœberschrift, **fett**, [Link](URL), ![Bild](URL)</span></label>
          <div class="md-toolbar" style="display:flex;gap:.3rem;margin-bottom:.3rem">
            <button type="button" onclick="mdInsert('s-wahlinfo-content','bold')" style="padding:.25rem .5rem;font-size:.78rem;border:1px solid #d0d0d0;border-radius:5px;background:#f5f5f7;cursor:pointer"><b>B</b></button>
            <button type="button" onclick="mdInsert('s-wahlinfo-content','italic')" style="padding:.25rem .5rem;font-size:.78rem;border:1px solid #d0d0d0;border-radius:5px;background:#f5f5f7;cursor:pointer"><i>I</i></button>
            <button type="button" onclick="mdInsert('s-wahlinfo-content','link')" style="padding:.25rem .5rem;font-size:.78rem;border:1px solid #d0d0d0;border-radius:5px;background:#f5f5f7;cursor:pointer">ğŸ”— Link</button>
            <button type="button" onclick="mdInsert('s-wahlinfo-content','image')" style="padding:.25rem .5rem;font-size:.78rem;border:1px solid #d0d0d0;border-radius:5px;background:#f5f5f7;cursor:pointer">ğŸ–¼ï¸ Bild</button>
            <button type="button" onclick="mdInsert('s-wahlinfo-content','h2')" style="padding:.25rem .5rem;font-size:.78rem;border:1px solid #d0d0d0;border-radius:5px;background:#f5f5f7;cursor:pointer">H2</button>
            <button type="button" onclick="mdInsert('s-wahlinfo-content','h3')" style="padding:.25rem .5rem;font-size:.78rem;border:1px solid #d0d0d0;border-radius:5px;background:#f5f5f7;cursor:pointer">H3</button>
            <button type="button" onclick="mdInsert('s-wahlinfo-content','hr')" style="padding:.25rem .5rem;font-size:.78rem;border:1px solid #d0d0d0;border-radius:5px;background:#f5f5f7;cursor:pointer">â€”</button>
          </div>
          <textarea id="s-wahlinfo-content" rows="20" style="font-family:inherit;font-size:.88rem;line-height:1.5"></textarea>
        </div>
        <div style="display:flex;gap:1rem;align-items:center;margin-top:.75rem">
          <button class="save-btn" id="save-wahlinfo-btn">Speichern</button>
          <div class="form-msg" id="wahlinfo-msg"></div>
          <a href="/wahlinfo/" target="_blank" style="font-size:.85rem;color:var(--primary);margin-left:auto">Vorschau â†’</a>
        </div>
      </div>
    </section>
  </div>

  <!-- â•â•â• Tab: SMTP â•â•â• -->
  <div class="tab-panel" id="tab-smtp">
    <section class="panel">
      <div class="panel-header"><h2>ğŸ“§ E-Mail / SMTP-Einstellungen</h2></div>
      <p style="font-size:.85rem;color:var(--text-secondary);margin-bottom:1rem">
        SMTP-Server zum Versenden von E-Mail-Benachrichtigungen. Kandidaten kÃ¶nnen in ihrem Admin-Bereich Benachrichtigungen aktivieren.
      </p>
      <div class="form-grid">
        <div class="form-group">
          <label for="s-smtp-host">SMTP-Server</label>
          <input type="text" id="s-smtp-host" placeholder="z.B. smtp.gmail.com">
        </div>
        <div class="form-group">
          <label for="s-smtp-port">Port</label>
          <input type="number" id="s-smtp-port" placeholder="587" value="587" style="max-width:120px">
        </div>
        <div class="form-group">
          <label for="s-smtp-user">Benutzername</label>
          <input type="text" id="s-smtp-user" placeholder="user@gmail.com" autocomplete="off">
        </div>
        <div class="form-group">
          <label for="s-smtp-pass">Passwort / App-Passwort</label>
          <input type="password" id="s-smtp-pass" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" autocomplete="new-password">
        </div>
        <div class="form-group">
          <label for="s-smtp-from">Absender-Adresse (From)</label>
          <input type="email" id="s-smtp-from" placeholder="wahlplattform@example.de">
          <p class="hint">Leer = gleich wie Benutzername</p>
        </div>
        <div class="form-group">
          <label style="display:flex;align-items:center;gap:.5rem;cursor:pointer;margin-top:1.5rem">
            <input type="checkbox" id="s-smtp-tls" checked style="width:18px;height:18px;accent-color:var(--primary)">
            STARTTLS verwenden
          </label>
        </div>
        <div class="form-group">
          <label for="s-digest-hour">Tagesberichte versenden um (Uhr)</label>
          <input type="number" id="s-digest-hour" min="0" max="23" value="7" style="max-width:80px">
          <p class="hint">0â€“23, z.B. 7 = 07:00 Uhr morgens</p>
        </div>
      </div>
      <div style="display:flex;gap:.75rem;align-items:center;flex-wrap:wrap;margin-top:.5rem">
        <button class="btn-save" id="save-smtp">ğŸ’¾ SMTP speichern</button>
        <button class="btn-save" id="test-smtp" style="background:linear-gradient(135deg,#16a34a,#15803d)">ğŸ” Verbindung testen</button>
        <span class="save-msg" id="smtp-msg"></span>
      </div>
      <div id="smtp-diagnose" style="margin-top:1rem;display:none">
        <h3 style="font-size:.9rem;margin-bottom:.5rem">Diagnose-Ergebnis</h3>
        <div id="smtp-diagnose-steps"></div>
      </div>
    </section>
  </div>

  <!-- â•â•â• Tab: Data â•â•â• -->
  <div class="tab-panel" id="tab-data">
    <!-- Analytics Section -->
    <section class="panel">
      <div class="panel-header"><h2>ğŸ“Š Statistikdaten</h2></div>
      <p style="font-size:.85rem;color:var(--text-secondary);margin-bottom:1rem">Besuche, Umfrage-Stimmen, Quiz-Antworten und RÃ¼ckmeldungen aller Kandidaten.</p>
      <div style="display:flex;gap:1rem;flex-wrap:wrap;align-items:flex-start">
        <div>
          <h3 style="font-size:.9rem;margin-bottom:.5rem">Export</h3>
          <div class="exports-row">
            <button class="export-btn primary" id="btn-export-analytics">ğŸ“¥ Statistik exportieren (JSON)</button>
          </div>
        </div>
        <div>
          <h3 style="font-size:.9rem;margin-bottom:.5rem">Import</h3>
          <div class="exports-row">
            <button class="export-btn green" id="btn-import-analytics-trigger">ğŸ“¤ Statistik importieren</button>
            <input type="file" accept=".json" id="file-analytics-import" style="display:none">
          </div>
        </div>
        <div>
          <h3 style="font-size:.9rem;margin-bottom:.5rem">ZurÃ¼cksetzen</h3>
          <div class="exports-row">
            <button class="export-btn" id="btn-reset-analytics" style="border-color:#fca5a5;color:#dc2626">ğŸ—‘ï¸ Alle Statistiken lÃ¶schen</button>
          </div>
        </div>
      </div>
      <div class="form-msg" id="analytics-msg" style="margin-top:.75rem"></div>
    </section>

    <!-- DB Section -->
    <section class="panel">
      <div class="panel-header"><h2>ğŸ—„ï¸ Datenbank</h2></div>
      <div style="display:flex;gap:1.5rem;flex-wrap:wrap;align-items:flex-start">
        <div>
          <h3 style="font-size:.9rem;margin-bottom:.5rem">Export</h3>
          <div class="exports-row">
            <button class="export-btn primary" id="btn-export-db">ğŸ—„ï¸ Datenbank herunterladen</button>
          </div>
        </div>
        <div>
          <h3 style="font-size:.9rem;margin-bottom:.5rem">Import</h3>
          <div class="upload-card" id="uc-db-import">
            <h3>Datenbank importieren</h3>
            <p>SQLite .db Â· Ersetzt die gesamte Datenbank</p>
            <input type="file" accept=".db" class="upload-input" id="file-db-import">
            <label for="file-db-import" class="upload-label">ğŸ“¥ Datei wÃ¤hlen</label>
            <div class="upload-status" id="status-db-import"></div>
          </div>
        </div>
      </div>
    </section>

    <!-- GeoIP Section -->
    <section class="panel">
      <div class="panel-header"><h2>ğŸŒ GeoIP Datenbank</h2></div>
      <div id="geoip-status" style="margin-bottom:1rem"></div>
      <div class="upload-card" id="uc-geoip" style="max-width:400px">
        <h3>GeoLite2-City Datenbank</h3>
        <p>GeoLite2-City.mmdb Â· max. 150 MB Â· gilt fÃ¼r alle Kandidaten</p>
        <input type="file" accept=".mmdb" class="upload-input" id="file-geoip">
        <label for="file-geoip" class="upload-label">ğŸŒ Datei wÃ¤hlen</label>
        <div class="upload-status" id="status-geoip"></div>
      </div>
      <button class="btn-save" id="refresh-geoip" style="margin-top:.75rem;background:linear-gradient(135deg,#6A3FB5,#553098)">ğŸ”„ GeoIP-Status aktualisieren</button>
    </section>
  </div>
</div>

<script>
(function(){
"use strict";
var auth="";
var STORE_KEY="wahl_platform_admin";

// â”€â”€ Tabs â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.querySelectorAll(".tab-btn").forEach(function(b){
  b.addEventListener("click",function(){
    if(b.dataset.tab==="data") loadGeoIpStatus();
    document.querySelectorAll(".tab-btn").forEach(function(t){t.classList.remove("active")});
    document.querySelectorAll(".tab-panel").forEach(function(p){p.classList.remove("active")});
    b.classList.add("active");
    document.getElementById("tab-"+b.dataset.tab).classList.add("active");
    // Load settings when switching to that tab
    if(b.dataset.tab==="settings"||b.dataset.tab==="wahlinfo") loadSettings();
    if(b.dataset.tab==="smtp") loadSmtp();
  });
});

// â”€â”€ Login â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var loginBtn=document.getElementById("login-btn");
var passInput=document.getElementById("pass");
var userInput=document.getElementById("user");
loginBtn.addEventListener("click",doLogin);
passInput.addEventListener("keydown",function(e){if(e.key==="Enter")doLogin()});
userInput.addEventListener("keydown",function(e){if(e.key==="Enter")passInput.focus()});

var saved=localStorage.getItem(STORE_KEY);
if(saved){auth=saved;apiFetch("/platform/stats").then(function(d){
  showDash();renderStats(d);
}).catch(function(){localStorage.removeItem(STORE_KEY);auth=""});}

document.getElementById("logout-btn").addEventListener("click",function(e){
  e.preventDefault();localStorage.removeItem(STORE_KEY);auth="";
  document.getElementById("dashboard-view").hidden=true;document.getElementById("login-view").hidden=false;
  userInput.value="";passInput.value="";document.getElementById("login-error").hidden=true;
  loginBtn.textContent="Anmelden";loginBtn.disabled=false;
});

function doLogin(){
  var u=userInput.value,p=passInput.value;auth="Basic "+btoa(u+":"+p);
  loginBtn.textContent="Ladenâ€¦";loginBtn.disabled=true;
  apiFetch("/platform/stats").then(function(d){
    localStorage.setItem(STORE_KEY,auth);showDash();renderStats(d);
  }).catch(function(){
    document.getElementById("login-error").hidden=false;
    loginBtn.textContent="Anmelden";loginBtn.disabled=false;auth="";
  });
}

function showDash(){document.getElementById("login-view").hidden=true;document.getElementById("dashboard-view").hidden=false}

function apiFetch(url,opts){
  opts=opts||{};opts.headers=Object.assign({"Authorization":auth},opts.headers||{});
  return fetch("/api"+url,opts).then(function(r){if(!r.ok)throw new Error(r.status);return r.json()});
}

// â”€â”€ Stats â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function renderStats(d){
  document.getElementById("sv-candidates").textContent=num(d.candidate_count);
  document.getElementById("sv-visits").textContent=num(d.total_visits);
  document.getElementById("sv-unique").textContent=num(d.unique_today);
  document.getElementById("sv-polls").textContent=num(d.total_polls);
  document.getElementById("sv-quiz").textContent=num(d.total_quiz);
  document.getElementById("sv-feedback").textContent=num(d.total_feedback);
  document.getElementById("cand-badge").textContent=d.candidate_count+" registriert";
  renderDaily(d.daily);renderCandidates(d.candidates);
}

function num(n){return(n||0).toLocaleString("de-DE")}

function renderDaily(daily){
  var c=document.getElementById("daily-chart"),avg=document.getElementById("daily-avg");
  if(!daily||!daily.length){c.innerHTML='<p class="empty">Keine Daten</p>';avg.textContent="";return}
  var max=Math.max.apply(null,daily.map(function(d){return d.total}));
  var sum=daily.reduce(function(s,d){return s+d.total},0);
  avg.textContent="Ã˜ "+Math.round(sum/daily.length)+"/Tag";
  c.innerHTML=daily.map(function(d){var pct=max?Math.round(d.total/max*100):0;var ds=d.day.length>5?d.day.substring(5):d.day;
    return '<div class="bar-row"><div class="bar-top"><span class="bar-label">'+esc(ds)+'</span><span class="bar-value">'+d.total+' <span style="color:#aaa">('+d.uniq+' uniq)</span></span></div><div class="bar-track"><div class="bar-fill" style="width:'+pct+'%"></div></div></div>';
  }).join("");
}

function renderCandidates(candidates){
  var tb=document.querySelector("#tbl-candidates tbody");
  if(!candidates||!candidates.length){tb.innerHTML='<tr><td colspan="7" class="empty">Keine Kandidaten</td></tr>';return}
  tb.innerHTML=candidates.map(function(c){
    return '<tr>'+
      '<td><a href="/'+esc(c.slug)+'/" style="text-decoration:none;color:inherit"><span class="candidate-color" style="background:'+esc(c.theme_color)+'"></span><strong>'+esc(c.name)+'</strong><span class="mini">'+esc(c.party||"\u2013")+' \u00b7 /'+esc(c.slug)+'/</span></a></td>'+
      '<td style="text-align:right">'+num(c.visits)+'</td>'+
      '<td style="text-align:right">'+num(c.polls)+'</td>'+
      '<td style="text-align:right">'+num(c.quiz)+'</td>'+
      '<td style="text-align:right">'+num(c.feedback)+'</td>'+
      '<td style="text-align:right">'+c.pages+'</td>'+
      '<td style="white-space:nowrap">'+
      '<a href="/'+esc(c.slug)+'/admin/" class="btn-link" style="font-size:.78rem">Admin \u2192</a> '+
      '<button class="btn-sm" onclick="exportSingleCandidate(\''+esc(c.slug)+'\')" title="Kandidat exportieren">\u2b07</button> '+
      '<button class="btn-sm btn-sm-import" onclick="importSingleCandidate(\''+esc(c.slug)+'\',\''+esc(c.name)+'\')" title="Kandidat importieren">\u2b06</button> '+
      '<div class="cand-dropdown" style="display:inline-block"><button class="btn-sm btn-sm-stats" onclick="toggleCandMenu(this)" title="Statistik-Aktionen">\ud83d\udcca</button>'+
      '<div class="cand-dropdown-menu">'+
      '<button onclick="exportCandAnalytics(\''+esc(c.slug)+'\',\''+esc(c.name)+'\')">\ud83d\udce5 Statistik exportieren</button>'+
      '<button onclick="importCandAnalytics(\''+esc(c.slug)+'\',\''+esc(c.name)+'\')">\ud83d\udce4 Statistik importieren</button>'+
      '<hr>'+
      '<button class="text-red" onclick="resetCandAnalytics(\''+esc(c.slug)+'\',\''+esc(c.name)+'\')">\ud83d\uddd1\ufe0f Statistik zur\u00fccksetzen</button>'+
      '</div></div> '+
      '<button class="btn-danger" onclick="deleteCandidate(\''+esc(c.slug)+'\',\''+esc(c.name)+'\')">L\u00f6schen</button>'+
      '<button class="btn-sm" onclick="resetCandPassword(\''+esc(c.slug)+'\',\''+esc(c.name)+'\')" title="Passwort zur\u00fccksetzen">\ud83d\udd11</button> '+
      '</td>'+
      '</tr>';
  }).join("");
}

// â”€â”€ Register â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById("reg-name").addEventListener("input",function(){
  var slug=this.value.toLowerCase()
    .replace(/[Ã¤Ã„]/g,"ae").replace(/[Ã¶Ã–]/g,"oe").replace(/[Ã¼Ãœ]/g,"ue").replace(/[ÃŸ]/g,"ss")
    .replace(/[^a-z0-9]+/g,"").substring(0,40);
  document.getElementById("reg-slug").value=slug;
});

var regBtn=document.getElementById("register-btn");
var regMsg=document.getElementById("reg-msg");
regBtn.addEventListener("click",function(){
  var name=document.getElementById("reg-name").value.trim();
  var slug=document.getElementById("reg-slug").value.trim();
  var user=document.getElementById("reg-user").value.trim();
  var pass=document.getElementById("reg-pass").value;
  regMsg.textContent="";
  if(!name||!slug||!user||!pass){fm(regMsg,"Bitte alle Felder ausfÃ¼llen.","err");return}
  if(!/^[a-z0-9\-]+$/.test(slug)){fm(regMsg,"URL-KÃ¼rzel: nur Kleinbuchstaben, Zahlen, Bindestriche.","err");return}
  if(pass.length<6){fm(regMsg,"Passwort mind. 6 Zeichen.","err");return}
  regBtn.disabled=true;regBtn.textContent="Erstelleâ€¦";
  fetch("/api/register",{
    method:"POST",
    headers:{"Content-Type":"application/json","Authorization":auth},
    body:JSON.stringify({name:name,slug:slug,admin_user:user,admin_pass:pass})
  }).then(function(r){return r.json().then(function(d){return{ok:r.ok,data:d}})})
  .then(function(res){
    if(res.ok){
      fm(regMsg,'âœ… Kandidat \u201E'+name+'\u201C erstellt! \u2192 /'+slug+'/','ok');
      document.getElementById("reg-name").value="";document.getElementById("reg-slug").value="";
      document.getElementById("reg-user").value="";document.getElementById("reg-pass").value="";
      // Reload candidates
      apiFetch("/platform/stats").then(renderStats).catch(function(){});
    } else {
      fm(regMsg,res.data.detail||"Fehler","err");
    }
    regBtn.disabled=false;regBtn.textContent="Kandidat erstellen";
  }).catch(function(){
    fm(regMsg,"Netzwerkfehler","err");regBtn.disabled=false;regBtn.textContent="Kandidat erstellen";
  });
});

// â”€â”€ Settings â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var settingsLoaded=false;
function loadSettings(){
  if(settingsLoaded)return;
  apiFetch("/platform/settings").then(function(d){
    settingsLoaded=true;
    document.getElementById("s-site-title").value=d.site_title||"";
    document.getElementById("s-site-subtitle").value=d.site_subtitle||"";
    document.getElementById("s-hero-headline").value=d.hero_headline||"";
    document.getElementById("s-hero-text").value=d.hero_text||"";
    document.getElementById("s-campaign-title").value=d.campaign_title||"";
    document.getElementById("s-campaign-text").value=d.campaign_text||"";
    document.getElementById("s-footer-text").value=d.footer_text||"";
    document.getElementById("s-show-candidates").checked=(d.show_candidates!=="0");
    document.getElementById("s-redirect-url").value=d.redirect_url||"";
    document.getElementById("s-wahlinfo-enabled").checked=(d.wahlinfo_enabled==="1");
    document.getElementById("s-wahlinfo-title").value=d.wahlinfo_title||"";
    document.getElementById("s-wahlinfo-content").value=d.wahlinfo_content||"";
  }).catch(function(){});
}

var saveBtn=document.getElementById("save-settings-btn");
var settingsMsg=document.getElementById("settings-msg");
saveBtn.addEventListener("click",function(){
  var payload={
    site_title:document.getElementById("s-site-title").value,
    site_subtitle:document.getElementById("s-site-subtitle").value,
    hero_headline:document.getElementById("s-hero-headline").value,
    hero_text:document.getElementById("s-hero-text").value,
    campaign_title:document.getElementById("s-campaign-title").value,
    campaign_text:document.getElementById("s-campaign-text").value,
    footer_text:document.getElementById("s-footer-text").value,
    show_candidates:document.getElementById("s-show-candidates").checked?"1":"0",
    redirect_url:document.getElementById("s-redirect-url").value.trim(),
  };
  saveBtn.disabled=true;saveBtn.textContent="Speichernâ€¦";settingsMsg.textContent="";
  fetch("/api/platform/settings",{
    method:"PUT",
    headers:{"Content-Type":"application/json","Authorization":auth},
    body:JSON.stringify(payload)
  }).then(function(r){if(!r.ok)throw new Error();return r.json()})
  .then(function(){
    fm(settingsMsg,"âœ… Gespeichert! Startseite aktualisiert.","ok");
    saveBtn.disabled=false;saveBtn.textContent="Speichern";
    settingsLoaded=false; // reload on next visit
  }).catch(function(){
    fm(settingsMsg,"âŒ Fehler beim Speichern","err");
    saveBtn.disabled=false;saveBtn.textContent="Speichern";
  });
});

// â”€â”€ Wahlinfo Save â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var wahlinfoBtn=document.getElementById("save-wahlinfo-btn");
var wahlinfoMsg=document.getElementById("wahlinfo-msg");
wahlinfoBtn.addEventListener("click",function(){
  var payload={
    wahlinfo_enabled:document.getElementById("s-wahlinfo-enabled").checked?"1":"0",
    wahlinfo_title:document.getElementById("s-wahlinfo-title").value,
    wahlinfo_content:document.getElementById("s-wahlinfo-content").value,
  };
  wahlinfoBtn.disabled=true;wahlinfoBtn.textContent="Speichernâ€¦";wahlinfoMsg.textContent="";
  fetch("/api/platform/settings",{
    method:"PUT",
    headers:{"Content-Type":"application/json","Authorization":auth},
    body:JSON.stringify(payload)
  }).then(function(r){if(!r.ok)throw new Error();return r.json()})
  .then(function(){
    fm(wahlinfoMsg,"âœ… Wahlinfo gespeichert!","ok");
    wahlinfoBtn.disabled=false;wahlinfoBtn.textContent="Speichern";
    settingsLoaded=false;
  }).catch(function(){
    fm(wahlinfoMsg,"âŒ Fehler beim Speichern","err");
    wahlinfoBtn.disabled=false;wahlinfoBtn.textContent="Speichern";
  });
});

// â”€â”€ SMTP Settings â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var smtpLoaded=false;
function loadSmtp(){
  if(smtpLoaded)return;
  apiFetch("/platform/settings").then(function(d){
    smtpLoaded=true;
    document.getElementById("s-smtp-host").value=d.smtp_host||"";
    document.getElementById("s-smtp-port").value=d.smtp_port||"587";
    document.getElementById("s-smtp-user").value=d.smtp_user||"";
    document.getElementById("s-smtp-pass").value=d.smtp_pass||"";
    document.getElementById("s-smtp-from").value=d.smtp_from||"";
    document.getElementById("s-smtp-tls").checked=(d.smtp_tls!=="0");
    document.getElementById("s-digest-hour").value=d.digest_hour||"7";
  }).catch(function(){});
}

var smtpBtn=document.getElementById("save-smtp");
var smtpMsg=document.getElementById("smtp-msg");
smtpBtn.addEventListener("click",function(){
  var payload={
    smtp_host:document.getElementById("s-smtp-host").value.trim(),
    smtp_port:document.getElementById("s-smtp-port").value,
    smtp_user:document.getElementById("s-smtp-user").value.trim(),
    smtp_pass:document.getElementById("s-smtp-pass").value,
    smtp_from:document.getElementById("s-smtp-from").value.trim(),
    smtp_tls:document.getElementById("s-smtp-tls").checked?"1":"0",
    digest_hour:document.getElementById("s-digest-hour").value,
  };
  smtpBtn.disabled=true;smtpBtn.textContent="Speichernâ€¦";smtpMsg.textContent="";
  fetch("/api/platform/settings",{
    method:"PUT",
    headers:{"Content-Type":"application/json","Authorization":auth},
    body:JSON.stringify(payload)
  }).then(function(r){if(!r.ok)throw new Error();return r.json()})
  .then(function(){
    fm(smtpMsg,"âœ… SMTP gespeichert!","ok");
    smtpBtn.disabled=false;smtpBtn.textContent="ğŸ’¾ SMTP speichern";
    smtpLoaded=false;
  }).catch(function(){
    fm(smtpMsg,"âŒ Fehler beim Speichern","err");
    smtpBtn.disabled=false;smtpBtn.textContent="ğŸ’¾ SMTP speichern";
  });
});

// â”€â”€ SMTP Diagnose â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var testSmtpBtn=document.getElementById("test-smtp");
testSmtpBtn.addEventListener("click",function(){
  testSmtpBtn.disabled=true;testSmtpBtn.textContent="Testeâ€¦";smtpMsg.textContent="";
  var diagPanel=document.getElementById("smtp-diagnose");
  var diagSteps=document.getElementById("smtp-diagnose-steps");
  diagPanel.style.display="block";diagSteps.innerHTML='<p style="color:#8e8e93">Verbindung wird geprÃ¼ftâ€¦</p>';
  fetch("/api/platform/smtp/diagnose",{headers:{"Authorization":auth}})
  .then(function(r){if(!r.ok)throw new Error();return r.json()})
  .then(function(d){
    testSmtpBtn.disabled=false;testSmtpBtn.textContent="ğŸ” Verbindung testen";
    diagSteps.innerHTML=d.steps.map(function(s){
      var icon=s.ok?"âœ…":"âŒ";
      var bg=s.ok?"#f0fff4":"#fff5f5";
      var border=s.ok?"#16a34a":"#dc2626";
      return '<div style="display:flex;gap:.75rem;align-items:flex-start;padding:.6rem .8rem;margin:.3rem 0;background:'+bg+';border-left:3px solid '+border+';border-radius:0 6px 6px 0">'+
        '<span style="font-size:1.1rem">'+icon+'</span>'+
        '<div><strong style="font-size:.85rem">'+esc(s.step)+'</strong><p style="margin:.2rem 0 0;font-size:.8rem;color:#555">'+esc(s.detail)+'</p></div></div>';
    }).join("");
    if(d.ok){fm(smtpMsg,"âœ… SMTP-Server erreichbar und bereit!","ok")}
    else{fm(smtpMsg,"âŒ SMTP-Test fehlgeschlagen â€“ Details unten","err")}
  }).catch(function(){
    testSmtpBtn.disabled=false;testSmtpBtn.textContent="ğŸ” Verbindung testen";
    fm(smtpMsg,"âŒ Fehler bei der Diagnose","err");
    diagSteps.innerHTML='<p style="color:#dc2626">Verbindungstest fehlgeschlagen.</p>';
  });
});

// â”€â”€ GeoIP Status â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function loadGeoIpStatus(){
  fetch("/api/platform/geoip/status",{headers:{"Authorization":auth}})
  .then(function(r){if(!r.ok)throw new Error();return r.json()})
  .then(function(d){
    var el=document.getElementById("geoip-status");
    var statusIcon=d.loaded?"âœ…":"âŒ";
    var statusText=d.loaded?"Geladen & aktiv":"Nicht geladen";
    var html='<div style="display:flex;gap:1rem;flex-wrap:wrap">';
    html+='<div style="background:'+(d.loaded?"#f0fff4":"#fff5f5")+';border:1px solid '+(d.loaded?"#bbf7d0":"#fecaca")+';border-radius:8px;padding:.75rem 1rem;min-width:200px">'+
      '<div style="font-size:1.1rem;font-weight:700">'+statusIcon+' '+statusText+'</div>';
    if(d.db_exists){
      html+='<div style="font-size:.82rem;color:#555;margin-top:.3rem">Datei: '+esc(d.db_path)+'</div>';
      html+='<div style="font-size:.82rem;color:#555">GrÃ¶ÃŸe: '+d.db_size_mb+' MB</div>';
      if(d.build_date)html+='<div style="font-size:.82rem;color:#555">Build: '+esc(d.build_date)+'</div>';
      if(d.db_type)html+='<div style="font-size:.82rem;color:#555">Typ: '+esc(d.db_type)+'</div>';
    } else {
      html+='<div style="font-size:.82rem;color:#dc2626;margin-top:.3rem">Datei nicht gefunden: '+esc(d.db_path)+'</div>';
    }
    html+='</div>';
    if(d.visits_total>0){
      html+='<div style="background:#f0f8ff;border:1px solid #bfdbfe;border-radius:8px;padding:.75rem 1rem;min-width:200px">'+
        '<div style="font-size:1.1rem;font-weight:700">ğŸ“Š Geolokalisierung</div>'+
        '<div style="font-size:.82rem;color:#555;margin-top:.3rem">'+d.visits_geolocated+' / '+d.visits_total+' Besuche lokalisiert ('+d.geo_rate_pct+'%)</div>'+
        '<div style="font-size:.82rem;color:#555">'+d.visits_unknown+' ohne Standort</div>'+
        '<div style="background:#e5e7eb;border-radius:4px;height:8px;margin-top:.5rem;overflow:hidden">'+
        '<div style="background:#16a34a;height:100%;width:'+d.geo_rate_pct+'%;border-radius:4px"></div></div>'+
      '</div>';
    }
    html+='</div>';
    el.innerHTML=html;
  }).catch(function(){});
}
document.getElementById("refresh-geoip").addEventListener("click",loadGeoIpStatus);

// â”€â”€ Markdown Insert Helper â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function mdInsert(id,type){
  var ta=document.getElementById(id);
  var s=ta.selectionStart,e=ta.selectionEnd,sel=ta.value.substring(s,e);
  var ins="";
  if(type==="link"){var url=prompt("URL eingeben:","https://");if(!url)return;ins="["+(sel||"Linktext")+"]("+url+")"}
  else if(type==="image"){var url=prompt("Bild-URL eingeben:","https://");if(!url)return;ins="!["+(sel||"Bildbeschreibung")+"]("+url+")"}
  else if(type==="bold"){ins="**"+(sel||"Text")+"**"}
  else if(type==="italic"){ins="*"+(sel||"Text")+"*"}
  else if(type==="h2"){ins="\n## "+(sel||"Ãœberschrift")+"\n"}
  else if(type==="h3"){ins="\n### "+(sel||"UnterÃ¼berschrift")+"\n"}
  else if(type==="hr"){ins="\n---\n"}
  ta.value=ta.value.substring(0,s)+ins+ta.value.substring(e);
  ta.focus();ta.selectionStart=s;ta.selectionEnd=s+ins.length;
}

// â”€â”€ Analytics Export â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById("btn-export-analytics").addEventListener("click",function(){
  fetch("/api/platform/analytics/export",{headers:{"Authorization":auth}})
  .then(function(r){if(!r.ok)throw new Error();return r.blob()})
  .then(function(blob){var u=URL.createObjectURL(blob);var a=document.createElement("a");a.href=u;a.download="analytics_export.json";a.click();URL.revokeObjectURL(u)})
  .catch(function(){alert("Export fehlgeschlagen")});
});

// â”€â”€ Analytics Import â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var analyticsInput=document.getElementById("file-analytics-import");
var analyticsMsg=document.getElementById("analytics-msg");
document.getElementById("btn-import-analytics-trigger").addEventListener("click",function(){analyticsInput.click()});
analyticsInput.addEventListener("change",function(){
  if(!analyticsInput.files.length)return;
  var file=analyticsInput.files[0];
  if(!file.name.endsWith(".json")){fm(analyticsMsg,"Nur .json Dateien erlaubt","err");return}
  if(!confirm("Statistikdaten aus "+file.name+" importieren?\nDie Daten werden zu den bestehenden hinzugef\u00fcgt."))return;
  fm(analyticsMsg,"Importiere\u2026","");
  var fd=new FormData();fd.append("file",file);
  fetch("/api/platform/analytics/import",{method:"POST",headers:{"Authorization":auth},body:fd})
  .then(function(r){if(!r.ok)return r.json().then(function(d){throw new Error(d.detail||"Fehler")});return r.json()})
  .then(function(d){
    var t="\u2705 Import: "+num(d.imported.visits)+" Besuche, "+num(d.imported.poll_votes)+" Umfragen, "+num(d.imported.quiz_answers)+" Quiz, "+num(d.imported.feedback)+" R\u00fcckmeldungen";
    fm(analyticsMsg,t,"ok");
    apiFetch("/platform/stats").then(renderStats).catch(function(){});
  }).catch(function(err){fm(analyticsMsg,"\u274c "+err.message,"err")});
  analyticsInput.value="";
});

// â”€â”€ Analytics Reset â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById("btn-reset-analytics").addEventListener("click",function(){
  if(!confirm("\u26a0\ufe0f Alle Statistikdaten (Besuche, Umfragen, Quiz, R\u00fcckmeldungen) unwiderruflich l\u00f6schen?"))return;
  if(!confirm("Wirklich ALLE Statistiken l\u00f6schen? Diese Aktion kann nicht r\u00fcckg\u00e4ngig gemacht werden!"))return;
  fm(analyticsMsg,"L\u00f6sche\u2026","");
  fetch("/api/platform/analytics",{method:"DELETE",headers:{"Authorization":auth}})
  .then(function(r){if(!r.ok)return r.json().then(function(d){throw new Error(d.detail||"Fehler")});return r.json()})
  .then(function(d){
    var t="\u2705 Gel\u00f6scht: "+num(d.deleted.visits)+" Besuche, "+num(d.deleted.poll_votes)+" Umfragen, "+num(d.deleted.quiz_answers)+" Quiz, "+num(d.deleted.feedback)+" R\u00fcckmeldungen";
    fm(analyticsMsg,t,"ok");
    apiFetch("/platform/stats").then(renderStats).catch(function(){});
  }).catch(function(err){fm(analyticsMsg,"\u274c "+err.message,"err")});
});

// â”€â”€ DB Export â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById("btn-export-db").addEventListener("click",function(){
  fetch("/api/platform/export/db",{headers:{"Authorization":auth}})
  .then(function(r){if(!r.ok)throw new Error();return r.blob()})
  .then(function(blob){var u=URL.createObjectURL(blob);var a=document.createElement("a");a.href=u;a.download="platform_backup.db";a.click();URL.revokeObjectURL(u)})
  .catch(function(){alert("Export fehlgeschlagen")});
});

// â”€â”€ DB Import â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var dbInput=document.getElementById("file-db-import");
var dbStatus=document.getElementById("status-db-import");
var dbCard=document.getElementById("uc-db-import");
dbInput.addEventListener("change",function(){if(dbInput.files.length)doImportDB(dbInput.files[0])});
dbCard.addEventListener("dragover",function(e){e.preventDefault();dbCard.classList.add("dragover")});
dbCard.addEventListener("dragleave",function(){dbCard.classList.remove("dragover")});
dbCard.addEventListener("drop",function(e){e.preventDefault();dbCard.classList.remove("dragover");if(e.dataTransfer.files.length)doImportDB(e.dataTransfer.files[0])});

function doImportDB(file){
  if(!file.name.endsWith(".db")){dbStatus.className="upload-status err";dbStatus.textContent="âŒ Nur .db Dateien erlaubt";return}
  if(!confirm("âš ï¸ Die gesamte Datenbank wird ersetzt! Fortfahren?")){return}
  dbStatus.className="upload-status";dbStatus.textContent="Hochladenâ€¦ ("+fmtB(file.size)+")";
  var fd=new FormData();fd.append("file",file);
  fetch("/api/platform/import/db",{method:"POST",headers:{"Authorization":auth},body:fd})
  .then(function(r){if(!r.ok)return r.json().then(function(d){throw new Error(d.detail||"Fehler")});return r.json()})
  .then(function(d){
    dbStatus.className="upload-status ok";
    dbStatus.textContent="âœ… Import OK ("+d.tables.length+" Tabellen, "+fmtB(d.size)+")";
    apiFetch("/platform/stats").then(renderStats).catch(function(){});
  })
  .catch(function(err){dbStatus.className="upload-status err";dbStatus.textContent="âŒ "+err.message});
}

// â”€â”€ GeoIP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var geoInput=document.getElementById("file-geoip");
var geoStatus=document.getElementById("status-geoip");
var geoCard=document.getElementById("uc-geoip");
geoInput.addEventListener("change",function(){if(geoInput.files.length)doUploadGeoip(geoInput.files[0])});
geoCard.addEventListener("dragover",function(e){e.preventDefault();geoCard.classList.add("dragover")});
geoCard.addEventListener("dragleave",function(){geoCard.classList.remove("dragover")});
geoCard.addEventListener("drop",function(e){e.preventDefault();geoCard.classList.remove("dragover");if(e.dataTransfer.files.length)doUploadGeoip(e.dataTransfer.files[0])});
function doUploadGeoip(file){
  if(!file.name.endsWith(".mmdb")){geoStatus.className="upload-status err";geoStatus.textContent="âŒ Nur .mmdb";return}
  geoStatus.className="upload-status";geoStatus.textContent="Hochladenâ€¦ ("+fmtB(file.size)+")";
  var fd=new FormData();fd.append("file",file);
  fetch("/api/platform/upload/geoip",{method:"POST",headers:{"Authorization":auth},body:fd})
  .then(function(r){if(!r.ok)return r.json().then(function(d){throw new Error(d.detail||"Fehler")});return r.json()})
  .then(function(d){geoStatus.className="upload-status ok";geoStatus.textContent="âœ… "+d.file+" ("+fmtB(d.size)+")"+(d.loaded?" Â· geladen":" Â· nicht geladen")})
  .catch(function(err){geoStatus.className="upload-status err";geoStatus.textContent="âŒ "+err.message});
}

// â”€â”€ Delete Candidate â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.deleteCandidate=function(slug,name){
  if(!confirm('\u26a0\ufe0f Kandidat \u201e'+name+'\u201c und alle zugehÃ¶rigen Daten (Seiten, Umfragen, Besuche, Uploads) endg\u00fcltig l\u00f6schen?'))return;
  fetch('/api/platform/candidates/'+encodeURIComponent(slug),{
    method:'DELETE',headers:{'Authorization':auth}
  }).then(function(r){if(!r.ok)return r.json().then(function(d){throw new Error(d.detail)});return r.json()})
  .then(function(){
    apiFetch('/platform/stats').then(renderStats).catch(function(){});
  }).catch(function(err){alert('Fehler: '+err.message)});
}

// â”€â”€ Reset Candidate Password â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.resetCandPassword=function(slug,name){
  var pw=prompt('Neues Passwort f\u00fcr \u201e'+name+'\u201c eingeben (mind. 6 Zeichen):');
  if(!pw)return;
  if(pw.length<6){alert('Passwort muss mindestens 6 Zeichen haben.');return}
  fetch('/api/platform/candidates/'+encodeURIComponent(slug)+'/password',{
    method:'PUT',headers:{'Authorization':auth,'Content-Type':'application/json'},
    body:JSON.stringify({password:pw})
  }).then(function(r){if(!r.ok)return r.json().then(function(d){throw new Error(d.detail)});return r.json()})
  .then(function(){alert('Passwort f\u00fcr \u201e'+name+'\u201c wurde zur\u00fcckgesetzt.')})
  .catch(function(err){alert('Fehler: '+err.message)});
}

// â”€â”€ Export Candidates â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
document.getElementById('btn-export-candidates').addEventListener('click',function(){
  fetch('/api/platform/candidates/export',{headers:{'Authorization':auth}})
  .then(function(r){if(!r.ok)throw new Error();return r.blob()})
  .then(function(blob){
    var u=URL.createObjectURL(blob);var a=document.createElement('a');
    a.href=u;a.download='kandidaten_export.json';a.click();URL.revokeObjectURL(u);
  }).catch(function(){alert('Export fehlgeschlagen')});
});

// â”€â”€ Import Candidates â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
var candImportInput=document.getElementById('file-candidates-import');
var candImportMsg=document.getElementById('candidates-import-msg');
document.getElementById('btn-import-candidates-trigger').addEventListener('click',function(){candImportInput.click()});
candImportInput.addEventListener('change',function(){
  if(!candImportInput.files.length)return;
  var file=candImportInput.files[0];
  if(!file.name.endsWith('.json')){fm(candImportMsg,'Nur .json Dateien erlaubt','err');return}
  var reader=new FileReader();
  reader.onload=function(e){
    try{var data=JSON.parse(e.target.result)}catch(ex){fm(candImportMsg,'Ung\u00fcltige JSON-Datei','err');return}
    var candidates=Array.isArray(data)?data:(data.candidates||data);
    if(!Array.isArray(candidates)){fm(candImportMsg,'Ung\u00fcltiges Format','err');return}
    var overwrite=document.getElementById('import-overwrite').checked;
    var msg=candidates.length+' Kandidat(en) importieren'+(overwrite?' (bestehende werden \u00fcberschrieben)':'')+'?';
    if(!confirm(msg))return;
    fm(candImportMsg,'Importiere\u2026','');
    fetch('/api/platform/candidates/import',{
      method:'POST',
      headers:{'Content-Type':'application/json','Authorization':auth},
      body:JSON.stringify({candidates:candidates,overwrite:overwrite})
    }).then(function(r){if(!r.ok)return r.json().then(function(d){throw new Error(d.detail)});return r.json()})
    .then(function(d){
      var t='\u2705 '+d.imported.length+' importiert';
      if(d.skipped.length)t+=', '+d.skipped.length+' \u00fcbersprungen (existieren bereits)';
      fm(candImportMsg,t,'ok');
      apiFetch('/platform/stats').then(renderStats).catch(function(){});
    }).catch(function(err){fm(candImportMsg,'\u274c '+err.message,'err')});
  };
  reader.readAsText(file);
  candImportInput.value='';
});

// â”€â”€ Export Single Candidate â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.exportSingleCandidate=function(slug){
  fetch('/api/platform/candidates/'+encodeURIComponent(slug)+'/export',{headers:{'Authorization':auth}})
  .then(function(r){if(!r.ok)throw new Error();return r.blob()})
  .then(function(blob){
    var u=URL.createObjectURL(blob);var a=document.createElement('a');
    a.href=u;a.download=slug+'_export.json';a.click();URL.revokeObjectURL(u);
  }).catch(function(){alert('Export fehlgeschlagen')});
};

// â”€â”€ Import Single Candidate â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.importSingleCandidate=function(slug,name){
  var inp=document.createElement('input');
  inp.type='file';inp.accept='.json';
  inp.onchange=function(){
    if(!inp.files.length)return;
    var file=inp.files[0];
    if(!file.name.endsWith('.json')){alert('Nur .json Dateien erlaubt');return}
    if(!confirm('Daten f\u00fcr \u201e'+name+'\u201c aus '+file.name+' importieren?\nProfil, Seiten und Links werden aktualisiert.'))return;
    var fd=new FormData();fd.append('file',file);
    fetch('/api/platform/candidates/'+encodeURIComponent(slug)+'/import',{
      method:'POST',headers:{'Authorization':auth},body:fd
    }).then(function(r){if(!r.ok)return r.json().then(function(d){throw new Error(d.detail)});return r.json()})
    .then(function(d){
      var t='\u2705 Import f\u00fcr '+name+': ';
      if(d.imported.profile)t+='Profil aktualisiert, ';
      t+=d.imported.pages+' Seiten, '+d.imported.links+' neue Links';
      alert(t);
      apiFetch('/platform/stats').then(renderStats).catch(function(){});
    }).catch(function(err){alert('\u274c '+err.message)});
  };
  inp.click();
};

// â”€â”€ Helpers â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function fmtB(b){if(b<1024)return b+" B";if(b<1048576)return(b/1024).toFixed(1)+" KB";return(b/1048576).toFixed(1)+" MB"}
function esc(s){var d=document.createElement("div");d.textContent=String(s);return d.innerHTML}
function fm(el,text,cls){el.textContent=text;el.className="form-msg "+cls}

// â”€â”€ Candidate Dropdown Menu â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.toggleCandMenu=function(btn){
  var menu=btn.nextElementSibling;
  // Close all other menus first
  document.querySelectorAll('.cand-dropdown-menu.open').forEach(function(m){if(m!==menu)m.classList.remove('open')});
  menu.classList.toggle('open');
};
// Close dropdowns on outside click
document.addEventListener('click',function(e){
  if(!e.target.closest('.cand-dropdown')){
    document.querySelectorAll('.cand-dropdown-menu.open').forEach(function(m){m.classList.remove('open')});
  }
});

// â”€â”€ Per-Candidate Analytics Export â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.exportCandAnalytics=function(slug,name){
  fetch('/api/platform/candidates/'+encodeURIComponent(slug)+'/analytics/export',{headers:{'Authorization':auth}})
  .then(function(r){if(!r.ok)throw new Error();return r.blob()})
  .then(function(blob){
    var u=URL.createObjectURL(blob);var a=document.createElement('a');
    a.href=u;a.download=slug+'_analytics.json';a.click();URL.revokeObjectURL(u);
  }).catch(function(){alert('Export fehlgeschlagen')});
};

// â”€â”€ Per-Candidate Analytics Import â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.importCandAnalytics=function(slug,name){
  var inp=document.createElement('input');
  inp.type='file';inp.accept='.json';
  inp.onchange=function(){
    if(!inp.files.length)return;
    var file=inp.files[0];
    if(!file.name.endsWith('.json')){alert('Nur .json Dateien erlaubt');return}
    if(!confirm('Statistikdaten f\u00fcr \u201e'+name+'\u201c aus '+file.name+' importieren?\nDaten werden zu den bestehenden hinzugef\u00fcgt.'))return;
    var fd=new FormData();fd.append('file',file);
    fetch('/api/platform/candidates/'+encodeURIComponent(slug)+'/analytics/import',{
      method:'POST',headers:{'Authorization':auth},body:fd
    }).then(function(r){if(!r.ok)return r.json().then(function(d){throw new Error(d.detail)});return r.json()})
    .then(function(d){
      alert('\u2705 Statistik-Import f\u00fcr '+name+':\n'+num(d.imported.visits)+' Besuche, '+num(d.imported.poll_votes)+' Umfragen, '+num(d.imported.quiz_answers)+' Quiz, '+num(d.imported.feedback)+' R\u00fcckmeldungen');
      apiFetch('/platform/stats').then(renderStats).catch(function(){});
    }).catch(function(err){alert('\u274c '+err.message)});
  };
  inp.click();
};

// â”€â”€ Per-Candidate Analytics Reset â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
window.resetCandAnalytics=function(slug,name){
  if(!confirm('\u26a0\ufe0f Alle Statistikdaten f\u00fcr \u201e'+name+'\u201c (Besuche, Umfragen, Quiz, R\u00fcckmeldungen) l\u00f6schen?'))return;
  fetch('/api/platform/candidates/'+encodeURIComponent(slug)+'/analytics',{
    method:'DELETE',headers:{'Authorization':auth}
  }).then(function(r){if(!r.ok)return r.json().then(function(d){throw new Error(d.detail)});return r.json()})
  .then(function(d){
    alert('\u2705 Statistik f\u00fcr '+name+' gel\u00f6scht:\n'+num(d.deleted.visits)+' Besuche, '+num(d.deleted.poll_votes)+' Umfragen, '+num(d.deleted.quiz_answers)+' Quiz, '+num(d.deleted.feedback)+' R\u00fcckmeldungen');
    apiFetch('/platform/stats').then(renderStats).catch(function(){});
  }).catch(function(err){alert('\u274c '+err.message)});
};
})();
</script>
</body>
</html>
