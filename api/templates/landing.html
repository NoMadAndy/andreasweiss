<!DOCTYPE html>
<html lang="de">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Wahl 2026 – Kandidaten-Plattform</title>
<link rel="icon" type="image/svg+xml" href="/assets/img/favicon.svg">
<link rel="stylesheet" href="/assets/css/style.css">
<style>
/* Login */
#login-view{display:flex;align-items:center;justify-content:center;min-height:80vh}
.login-card{background:var(--card-bg);padding:2.5rem;border-radius:16px;box-shadow:var(--shadow);width:100%;max-width:380px}
.login-card h1{font-size:1.6rem;margin-bottom:.15rem;font-weight:700}
.login-card p.sub{color:var(--text-secondary);font-size:.85rem;margin-bottom:1.5rem}
.login-card input{display:block;width:100%;padding:.85rem 1rem;border:1.5px solid var(--border);border-radius:10px;font-size:1rem;margin-bottom:.75rem;font-family:var(--font);transition:border-color .2s}
.login-card input:focus{outline:none;border-color:#1e6fb9;box-shadow:0 0 0 3px rgba(30,111,185,.12)}
.login-card button{display:block;width:100%;padding:.85rem;background:linear-gradient(135deg,#1e6fb9,#1a5fa0);color:#fff;border:none;border-radius:10px;font-size:1rem;cursor:pointer;font-weight:600;font-family:var(--font)}
.login-card button:hover{transform:translateY(-1px);box-shadow:0 4px 12px rgba(30,111,185,.25)}
.login-error{color:#b91c1c;font-size:.85rem;margin-top:.5rem}

/* Dashboard */
.landing-hero{text-align:center;padding:3rem 0 2rem}
.landing-hero h1{font-size:2rem;font-weight:800;margin-bottom:.5rem}
.landing-hero p{color:var(--text-secondary);font-size:1.05rem;max-width:500px;margin:0 auto 2rem}
.candidates-list{display:grid;grid-template-columns:repeat(auto-fill,minmax(280px,1fr));gap:1rem;margin-bottom:2rem}
.cand-card{display:block;background:var(--card-bg);border-radius:var(--radius);padding:1.5rem;text-decoration:none;color:var(--text);box-shadow:var(--shadow);border-left:4px solid var(--cc,#1e6fb9);transition:transform .15s,box-shadow .15s}
.cand-card:hover{transform:translateY(-2px);box-shadow:0 4px 12px rgba(0,0,0,.12)}
.cand-card h2{font-size:1.15rem;margin-bottom:.25rem}
.cand-card .party{font-size:.85rem;color:var(--text-secondary)}
.cand-card .tagline{font-size:.8rem;color:var(--text-secondary);margin-top:.5rem}
.register-section{background:var(--card-bg);border-radius:var(--radius);padding:2rem;box-shadow:var(--shadow);max-width:480px;margin:0 auto 2rem}
.register-section h2{font-size:1.2rem;margin-bottom:1rem}
.form-group{margin-bottom:1rem}
.form-group label{display:block;font-size:.85rem;font-weight:600;margin-bottom:.35rem;color:var(--text)}
.form-group input{display:block;width:100%;padding:.75rem 1rem;border:2px solid var(--border);border-radius:8px;font-size:.95rem;font-family:var(--font)}
.form-group input:focus{outline:none;border-color:var(--theme-color)}
.form-group .hint{font-size:.75rem;color:var(--text-secondary);margin-top:.25rem}
.register-btn{display:block;width:100%;padding:.85rem;background:linear-gradient(135deg,#1e6fb9,#1a5fa0);color:#fff;border:none;border-radius:10px;font-size:1rem;cursor:pointer;font-weight:600;font-family:var(--font);transition:transform .1s}
.register-btn:hover{transform:translateY(-1px)}
.register-btn:disabled{opacity:.6;cursor:default}
.msg{margin-top:.75rem;font-size:.9rem;padding:.75rem;border-radius:8px}
.msg.ok{background:rgba(22,163,74,.08);color:#15803d}
.msg.err{background:rgba(220,38,38,.06);color:#b91c1c}
.empty-state{text-align:center;color:var(--text-secondary);padding:2rem 0;font-size:.95rem}
.top-bar{display:flex;justify-content:space-between;align-items:center;margin-bottom:1.5rem}
.top-bar .admin-links a{margin-left:1rem;font-size:.85rem;color:var(--text-secondary);text-decoration:none}
.top-bar .admin-links a:hover{color:var(--text)}
</style>
</head>
<body data-page="landing" data-slug="">
<header class="site-header">
    <div class="container">
        <a href="/" class="site-logo">Wahl 2026</a>
        <span class="site-tagline">macherwerkstatt.cc</span>
    </div>
</header>

<!-- ── Login View ─────────────────────────────────────────── -->
<main class="container">
  <div id="login-view">
    <div class="login-card">
      <h1>Plattform-Admin</h1>
      <p class="sub">Anmelden, um Kandidaten zu verwalten</p>
      <input type="text" id="login-user" placeholder="Benutzername" autocomplete="username">
      <input type="password" id="login-pass" placeholder="Passwort" autocomplete="current-password">
      <button id="login-btn">Anmelden</button>
      <p id="login-error" class="login-error" hidden>Ungültige Zugangsdaten</p>
    </div>
  </div>

  <!-- ── Dashboard (hidden until login) ───────────────────── -->
  <div id="dashboard-view" hidden>
    <section class="landing-hero">
        <h1>Kommunalwahl 2026</h1>
        <p>Erstelle deine eigene Kandidaten-Seite mit Umfragen, Quiz und Bürgerbeteiligung – kostenlos und DSGVO-konform.</p>
    </section>

    <div class="top-bar">
      <h2 style="font-size:1.1rem;margin:0">Aktive Kandidaten</h2>
      <span class="admin-links">
        <a href="/admin/">Plattform-Admin</a>
        <a href="#" id="logout-btn">Abmelden</a>
      </span>
    </div>

    <div id="candidates-container">
      <p class="empty-state">Lade Kandidaten…</p>
    </div>

    <section class="register-section">
        <h2>Neue Kandidaten-Seite anlegen</h2>
        <div class="form-group">
            <label for="reg-name">Dein Name</label>
            <input type="text" id="reg-name" placeholder="Max Mustermann">
        </div>
        <div class="form-group">
            <label for="reg-slug">URL-Kürzel</label>
            <input type="text" id="reg-slug" placeholder="maxmustermann" pattern="[a-z0-9\-]+" maxlength="40">
            <p class="hint">Nur Kleinbuchstaben, Zahlen und Bindestriche. Wird Teil der URL.</p>
        </div>
        <div class="form-group">
            <label for="reg-user">Admin-Benutzername</label>
            <input type="text" id="reg-user" placeholder="admin" autocomplete="username">
        </div>
        <div class="form-group">
            <label for="reg-pass">Admin-Passwort</label>
            <input type="password" id="reg-pass" placeholder="Sicheres Passwort" autocomplete="new-password">
        </div>
        <button class="register-btn" id="register-btn">Seite erstellen</button>
        <div id="reg-msg" class="msg" hidden></div>
    </section>
  </div>
</main>

<footer class="site-footer">
    <div class="container footer-main">
        <span style="color:#aaa;font-size:.7rem">Wahl 2026 · macherwerkstatt.cc · v{{ VERSION }}</span>
    </div>
</footer>

<script>
(function(){
"use strict";
var STORE_KEY="wahl_platform_admin";
var auth="";

// ── DOM refs ────────────────────────────────────────────────
var loginView=document.getElementById("login-view");
var dashboard=document.getElementById("dashboard-view");
var loginBtn=document.getElementById("login-btn");
var loginUser=document.getElementById("login-user");
var loginPass=document.getElementById("login-pass");
var loginErr=document.getElementById("login-error");
var btn=document.getElementById("register-btn");
var msg=document.getElementById("reg-msg");

// ── Login ───────────────────────────────────────────────────
loginBtn.addEventListener("click",doLogin);
loginPass.addEventListener("keydown",function(e){if(e.key==="Enter")doLogin()});
loginUser.addEventListener("keydown",function(e){if(e.key==="Enter")loginPass.focus()});

// Auto-login from stored credentials
var saved=localStorage.getItem(STORE_KEY);
if(saved){
  auth=saved;
  apiFetch("/platform/stats").then(function(){showDashboard();loadCandidates()})
  .catch(function(){localStorage.removeItem(STORE_KEY);auth=""});
}

function doLogin(){
  var u=loginUser.value.trim(),p=loginPass.value;
  if(!u||!p)return;
  auth="Basic "+btoa(u+":"+p);
  loginBtn.textContent="Laden…";loginBtn.disabled=true;loginErr.hidden=true;
  apiFetch("/platform/stats").then(function(){
    localStorage.setItem(STORE_KEY,auth);
    showDashboard();loadCandidates();
  }).catch(function(){
    loginErr.hidden=false;auth="";
    loginBtn.textContent="Anmelden";loginBtn.disabled=false;
  });
}

function showDashboard(){loginView.hidden=true;dashboard.hidden=false}

// ── Logout ──────────────────────────────────────────────────
document.getElementById("logout-btn").addEventListener("click",function(e){
  e.preventDefault();localStorage.removeItem(STORE_KEY);auth="";
  dashboard.hidden=true;loginView.hidden=false;
  loginUser.value="";loginPass.value="";loginErr.hidden=true;
  loginBtn.textContent="Anmelden";loginBtn.disabled=false;
});

// ── Candidates ──────────────────────────────────────────────
function loadCandidates(){
  apiFetch("/platform/stats").then(function(d){
    var container=document.getElementById("candidates-container");
    if(!d.per_candidate||d.per_candidate.length===0){
      container.innerHTML='<p class="empty-state">Noch keine Kandidaten registriert.</p>';
      return;
    }
    var html='<div class="candidates-list">';
    d.per_candidate.forEach(function(c){
      html+='<a href="/'+esc(c.slug)+'/" class="cand-card" style="--cc:'+esc(c.theme_color)+'">'
        +'<h2>'+esc(c.name)+'</h2>'
        +(c.party?'<p class="party">'+esc(c.party)+'</p>':'')
        +'</a>';
    });
    html+='</div>';
    container.innerHTML=html;
  });
}

// ── Register ────────────────────────────────────────────────
document.getElementById("reg-name").addEventListener("input",function(){
  var slug=this.value.toLowerCase()
    .replace(/[äÄ]/g,"ae").replace(/[öÖ]/g,"oe").replace(/[üÜ]/g,"ue").replace(/[ß]/g,"ss")
    .replace(/[^a-z0-9]+/g,"").substring(0,40);
  document.getElementById("reg-slug").value=slug;
});

btn.addEventListener("click",function(){
  var name=document.getElementById("reg-name").value.trim();
  var slug=document.getElementById("reg-slug").value.trim();
  var user=document.getElementById("reg-user").value.trim();
  var pass=document.getElementById("reg-pass").value;
  msg.hidden=true;
  if(!name||!slug||!user||!pass){showMsg("Bitte alle Felder ausfüllen.","err");return}
  if(!/^[a-z0-9\-]+$/.test(slug)){showMsg("URL-Kürzel: nur Kleinbuchstaben, Zahlen, Bindestriche.","err");return}
  if(pass.length<6){showMsg("Passwort muss mind. 6 Zeichen haben.","err");return}
  btn.disabled=true;btn.textContent="Erstelle…";
  fetch("/api/register",{
    method:"POST",
    headers:{"Content-Type":"application/json","Authorization":auth},
    body:JSON.stringify({name:name,slug:slug,admin_user:user,admin_pass:pass})
  }).then(function(r){return r.json().then(function(d){return{ok:r.ok,data:d}})})
  .then(function(res){
    if(res.ok){
      showMsg("Seite erstellt! Weiterleitung…","ok");
      setTimeout(function(){window.location.href="/"+res.data.slug+"/admin/"},1500);
    } else {
      showMsg(res.data.detail||"Fehler bei der Registrierung","err");
      btn.disabled=false;btn.textContent="Seite erstellen";
    }
  }).catch(function(){
    showMsg("Netzwerkfehler","err");btn.disabled=false;btn.textContent="Seite erstellen";
  });
});

// ── Helpers ─────────────────────────────────────────────────
function apiFetch(url,opts){
  opts=opts||{};opts.headers=Object.assign({"Authorization":auth},opts.headers||{});
  return fetch("/api"+url,opts).then(function(r){if(!r.ok)throw new Error(r.status);return r.json()});
}
function showMsg(text,cls){msg.textContent=text;msg.className="msg "+cls;msg.hidden=false}
function esc(s){var d=document.createElement("div");d.textContent=s||"";return d.innerHTML}
})();
</script>
</body>
</html>
